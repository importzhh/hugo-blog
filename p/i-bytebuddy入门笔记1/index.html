<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="简介 ByteBuddy支持检测和修改现有Java字节码的工具。 添加新的构造函数、方法和实例变量 删除现有构造函数、方法和实Ï例变量 修改实例变量"><title>I: ByteBuddy入门笔记1</title><link rel=canonical href=https://blog.importzhh.me/p/i-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01/><link rel=stylesheet href=/scss/style.min.0d8902b26558cddb5286ea49f2a7aadd5761ed898547e29e5ab572d8c0619ba6.css><meta property="og:title" content="I: ByteBuddy入门笔记1"><meta property="og:description" content="简介 ByteBuddy支持检测和修改现有Java字节码的工具。 添加新的构造函数、方法和实例变量 删除现有构造函数、方法和实Ï例变量 修改实例变量"><meta property="og:url" content="https://blog.importzhh.me/p/i-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01/"><meta property="og:site_name" content="importzhh的小破站"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="bytebuddy"><meta property="article:published_time" content="2023-08-06T17:06:29+08:00"><meta property="article:modified_time" content="2023-08-06T17:06:29+08:00"><meta name=twitter:title content="I: ByteBuddy入门笔记1"><meta name=twitter:description content="简介 ByteBuddy支持检测和修改现有Java字节码的工具。 添加新的构造函数、方法和实例变量 删除现有构造函数、方法和实Ï例变量 修改实例变量"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huce6e906a97de2553354850eae15a0392_8624_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>importzhh的小破站</a></h1><h2 class=site-description>实事求是 思危思退思变</h2></div></header><ol class=social-menu><li><a href=https://github.com/importzhh target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="-1.65 0 259.3 259.3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"><g><path fill="#9edcf2" d="M200.9 199.8c0 13.9-32.2 25.1-71.9 25.1-39.7.0-71.9-11.3-71.9-25.1.0-13.9 32.2-25.1 71.9-25.1C168.7 174.7 200.9 185.9 200.9 199.8zm0 0"/><g><defs><path id="SVGID_1_" d="M98.1 244.8c1.6 7.5 5.5 11.9 9.4 14.5h41.1c5-3.4 10.1-9.8 10.1-21.8v-31s.6-7.7 7.7-10.2c0 0 4.1-2.9-.3-4.5.0.0-19.5-1.6-19.5 14.4v23.6s.8 8.7-3.8 12.3v-29.2s.3-9.3 5.1-12.8c0 0 3.2-5.7-3.8-4.2.0.0-13.4 1.9-14 17.6l-.3 30h-3.2l-.3-30c-.6-15.6-14-17.6-14-17.6-7-1.6-3.8 4.2-3.8 4.2 4.8 3.5 5.1 12.8 5.1 12.8v29.5c-4.6-3.3-3.8-12.6-3.8-12.6v-23.6c0-16-19.5-14.4-19.5-14.4-4.5 1.6-.3 4.5-.3 4.5 7 2.6 7.7 10.2 7.7 10.2v21.7L98.1 244.8z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" overflow="visible"/></clipPath><path clip-path="url(#SVGID_2_)" fill="#7dbce7" d="M200.9 199.8c0 13.9-32.2 25.1-71.9 25.1-39.7.0-71.9-11.3-71.9-25.1.0-13.9 32.2-25.1 71.9-25.1C168.7 174.7 200.9 185.9 200.9 199.8zm0 0"/></g><path fill="#9edcf2" d="M46.9 125.9l-2.1 7.2s-.5 2.6 1.9 3.1c2.6-.1 2.4-2.5 2.2-3.2L46.9 125.9zm0 0"/><path fill="#010101" d="M255.8 95.6l.2-.9c-21.1-4.2-42.7-4.3-55.8-3.7 2.1-7.7 2.8-16.7 2.8-26.6.0-14.3-5.4-25.7-14-34.3 1.5-4.9 3.5-15.8-2-29.7.0.0-9.8-3.1-32.1 11.8-8.7-2.2-18-3.3-27.3-3.3-10.2.0-20.5 1.3-30.2 3.9C74.4-2.9 64.3.3 64.3.3c-6.6 16.5-2.5 28.8-1.3 31.8-7.8 8.4-12.5 19.1-12.5 32.2.0 9.9 1.1 18.8 3.9 26.5-13.2-.5-34-.3-54.4 3.8l.2.9c20.4-4.1 41.4-4.2 54.5-3.7.6 1.6 1.3 3.2 2 4.7-13 .4-35.1 2.1-56.3 8.1l.3.9c21.4-6 43.7-7.6 56.6-8 7.8 14.4 23 23.8 50.2 26.7-3.9 2.6-7.8 7-9.4 14.5-5.3 2.5-21.9 8.7-31.9-8.5.0.0-5.6-10.2-16.3-11 0 0-10.4-.2-.7 6.5.0.0 6.9 3.3 11.7 15.6.0.0 6.3 21 36.4 14.2V177s-.6 7.7-7.7 10.2c0 0-4.2 2.9.3 4.5.0.0 19.5 1.6 19.5-14.4v-23.6s-.8-9.4 3.8-12.6v38.8s-.3 9.3-5.1 12.8c0 0-3.2 5.7 3.8 4.2.0.0 13.4-1.9 14-17.6l.3-39.3h3.2l.3 39.3c.6 15.6 14 17.6 14 17.6 7 1.6 3.8-4.2 3.8-4.2-4.8-3.5-5.1-12.8-5.1-12.8v-38.5c4.6 3.6 3.8 12.3 3.8 12.3v23.6c0 16 19.5 14.4 19.5 14.4 4.5-1.6.3-4.5.3-4.5-7-2.6-7.7-10.2-7.7-10.2v-31c0-12.1-5.1-18.5-10.1-21.8 29-2.9 42.9-12.2 49.3-26.8 12.7.3 35.6 1.9 57.4 8.1l.3-.9c-21.7-6.1-44.4-7.7-57.3-8.1.6-1.5 1.1-3 1.6-4.6C212.9 91.4 234.6 91.4 255.8 95.6zm0 0"/><path fill="#f5ccb3" d="M174.6 63.7c6.2 5.7 9.9 12.5 9.9 19.8.0 34.4-25.6 35.3-57.2 35.3S70.1 114 70.1 83.5c0-7.3 3.6-14.1 9.8-19.7 10.3-9.4 27.7-4.4 47.4-4.4 19.7.0 37-5.1 47.3 4.3zm0 0"/><path fill="#fff" d="M108.3 85.3c0 9.5-5.3 17.1-11.9 17.1-6.6.0-11.9-7.7-11.9-17.1.0-9.5 5.3-17.1 11.9-17.1C103 68.1 108.3 75.8 108.3 85.3zm0 0"/><path fill="#af5c51" d="M104.5 85.5c0 6.3-3.6 11.4-7.9 11.4-4.4.0-7.9-5.1-7.9-11.4.0-6.3 3.6-11.4 7.9-11.4S104.5 79.2 104.5 85.5zm0 0"/><path fill="#fff" d="M172.2 85.3c0 9.5-5.3 17.1-11.9 17.1s-11.9-7.7-11.9-17.1c0-9.5 5.3-17.1 11.9-17.1C166.8 68.1 172.2 75.8 172.2 85.3zm0 0"/><path fill="#af5c51" d="M168.3 85.5c0 6.3-3.6 11.4-7.9 11.4-4.4.0-7.9-5.1-7.9-11.4.0-6.3 3.6-11.4 7.9-11.4C164.8 74.1 168.3 79.2 168.3 85.5zm0 0"/><path fill="#af5c51" d="M130.5 100.5c0 1.6-1.3 3-3 3-1.6.0-3-1.3-3-3s1.3-3 3-3c1.59999999999999.0 3 1.3 3 3zm0 0"/><path fill="#af5c51" d="M120.6 108c-.2-.5.1-1 .6-1.2s1 .1 1.2.6c.8 2.2 2.8 3.6 5.1 3.6s4.3-1.5 5.1-3.6c.2-.5.7-.8 1.2-.6s.8.7.6 1.2c-1 2.9-3.8 4.9-6.9 4.9C124.4 112.9 121.6 110.9 120.6 108zm0 0"/><path fill="#c4e5d9" d="M54.5 121.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4.0-.8.9-1.4 2.1-1.4C53.6 120.2 54.5 120.8 54.5 121.6zm0 0"/><path fill="#c4e5d9" d="M60.3 124.8c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4.0-.8.9-1.4 2.1-1.4C59.4 123.4 60.3 124 60.3 124.8zm0 0"/><path fill="#c4e5d9" d="M63.8 129c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C62.9 127.5 63.8 128.2 63.8 129zm0 0"/><path fill="#c4e5d9" d="M67 133.8c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C66.1 132.3 67 133 67 133.8zm0 0"/><path fill="#c4e5d9" d="M70.5 138.2c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C69.6 136.8 70.5 137.4 70.5 138.2zm0 0"/><path fill="#c4e5d9" d="M75.3 142.1c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C74.4 140.6 75.3 141.3 75.3 142.1zm0 0"/><path fill="#c4e5d9" d="M82 144.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4S82 143.8 82 144.6zm0 0"/><path fill="#c4e5d9" d="M88.7 144.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4S88.7 143.8 88.7 144.6zm0 0"/><path fill="#c4e5d9" d="M95.5 143.5c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C94.5 142.1 95.5 142.7 95.5 143.5zm0 0"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#简介>简介</a></li><li><a href=#代码初体验>代码初体验</a><ol><li><a href=#实例化>实例化</a></li><li><a href=#构造器策略><strong>构造器策略</strong></a></li><li><a href=#文件保存>文件保存</a></li><li><a href=#命名策略>命名策略</a></li><li><a href=#字节码注入jar包或指定目录>字节码注入jar包或指定目录</a></li><li><a href=#类加载策略>类加载策略</a></li></ol></li><li><a href=#增强一个类>增强一个类</a><ol><li><a href=#修改方法>修改方法</a></li><li><a href=#插入方法>插入方法</a></li><li><a href=#插入属性>插入属性</a></li><li><a href=#增强类>增强类</a></li><li><a href=#匹配方法>匹配方法</a></li><li><a href=#委托方法>委托方法</a></li><li><a href=#动态修改参数>动态修改参数</a></li><li><a href=#构造器方法>构造器方法</a></li><li><a href=#常用核心api>常用核心API</a></li></ol></li><li><a href=#链接>链接</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/jvm/>JVM</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/i-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01/>I: ByteBuddy入门笔记1</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Aug 06, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 18 分钟</time></div></footer></div></header><section class=article-content><h2 id=简介>简介</h2><ul><li>ByteBuddy支持检测和修改现有Java字节码的工具。</li><li>添加新的构造函数、方法和实例变量</li><li>删除现有构造函数、方法和实Ï例变量</li><li>修改实例变量的值。</li><li>修改方法参数的值。</li><li>检查现有的Java类结构、构造函数签名、方法签名和实例变量。</li><li>生成新的泛型Java类、构造函数、方法和实例变量（上界、下界、多界、通配符、参数化类型、方法类型参数）</li><li>搜索并替换方法中的代码。</li><li>添加和删除对Java类、构造函数、方法、实例变量和参数进行注释的注释</li><li>添加和修改Java内部类（添加第一级和第二级linner类，拦截内部类和匿名类）。</li><li>生成新的Java类、Java接口、枚举、注释和抽象类。</li><li>生成简单方法和lambda表达式。</li><li>在Advice代码之间共享数据。</li></ul><h2 id=代码初体验>代码初体验</h2><p>在进行Byte Buddy之前先创建一个项目，然后引入相关依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>net.bytebuddy<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>byte-buddy<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>1.12.10<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>org.junit.jupiter<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>junit-jupiter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>5.6.3<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>commons-io<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>commons-io<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>2.11.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>org.projectlombok<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>lombok<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>1.18.16<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>slf4j-log4j12<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>1.7.25<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>测试类如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateClassTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>String</span> <span class=n>path</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 每个测试方法执行前获取CreateClassTest的路径
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeAll</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>before</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span> <span class=o>=</span> <span class=n>CreateClassTest</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>().</span><span class=na>getResource</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=na>getPath</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 生成一个类
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>create</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Unloaded代表生成字节码还未加载到jvm
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=c1>//指定父类
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//获取生成类的字节码
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>DynamicType：在运行时创建的动态类型，通常作为应用DynamicType.Builder或.AuxiliaryType的结果。</p></li><li><p>Unloaded：尚未被给定ClassLoader加载的动态类型。</p><p><code>interface Unloaded&lt;T> extends DynamicType</code></p><p>类型参数: -由该动态类型实现的最具体的已知加载类型，通常是类型本身、接口或直接的超类。</p></li><li><p>ByteBuddy：在创建时，Byte Buddy会尝试发现当前JVM的版本。如果不可能，则创建与Java 6兼容的类文件。</p></li><li><p>subclass：用于创建所提供类型的子类，如果提供的类型是接口，则创建实现此接口类型的新类。</p><p>当扩展一个类时，Byte Buddy模仿子类类型的所有可见构造函数。任何构造函数都被实现为只调用其具有相同签名的超类型构造函数。另一种行为可以通过<code>subclass(Class, ConstructorStrategy)</code>提供显式的ConstructorStrategy来指定。 注意:如果所提供的类型声明了类型变量或所有者类型，则此方法以泛型状态实现它们。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl> <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 通过构造器策略生成一个类
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>createByConstructorStrategy</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Unloaded代表生成字节码还未加载到jvm
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//指定父类
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ConstructorStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>NO_CONSTRUCTORS</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//获取生成类的字节码
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=实例化>实例化</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>create</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Unloaded代表生成字节码还未加载到jvm
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//指定父类
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>loaded</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>()).</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=n>loaded</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;toString&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>loaded</span><span class=o>.</span><span class=na>newInstance</span><span class=o>()));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=构造器策略><strong>构造器策略</strong></h3><ul><li>NO_CONSTRUCTORS：此策略不添加构造函数</li><li>DEFAULT_CONSTRUCTOR：这个策略是添加一个默认构造函数来调用它的超类型默认构造函数。</li><li>IMITATE_SUPER_CLASS：这种策略是添加插装类型的超类的所有构造函数，其中每个构造函数都直接调用其签名等效的超类构造函数。</li><li>IMITATE_SUPER_CLASS_PUBLIC：这种策略是添加插装类型的超类的所有构造函数，其中每个构造函数都直接调用其签名等效的超类构造函数，只添加公共构造函数。</li><li>IMITATE_SUPER_CLASS_OPENING：这种策略是添加插装类型的超类的所有构造函数，其中每个构造函数都直接调用其签名等效的超类构造函数，为超类的任何可调用且声明为public的构造函数添加构造函数。</li></ul><p>上面是Byte Buddy注释的直译，具体的一些解释会在下面测试中解释。</p><p>为了测试以上策略创建一个类作为生成类得超类，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>content</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=nf>CreateByConstructorStrategyEntity</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=nf>CreateByConstructorStrategyEntity</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>content</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>content</span> <span class=o>=</span> <span class=n>content</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后用用上面五种策略分别生成新类，并保存到文件中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>createByConstructorStrategy</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Unloaded代表生成字节码还未加载到jvm
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//指定父类
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ConstructorStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>NO_CONSTRUCTORS</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>NO_CONSTRUCTORS：不生成构造器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity$ByteBuddy$3c1yosow</span> <span class=kd>extends</span> <span class=n>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>DEFAULT_CONSTRUCTOR：给一个默认构造器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity$ByteBuddy$sEqzBgYH</span> <span class=kd>extends</span> <span class=n>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$sEqzBgYH</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>IMITATE_SUPER_CLASS：添加超类所有可访问的构造器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity$ByteBuddy$w3TC5Z4k</span> <span class=kd>extends</span> <span class=n>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$w3TC5Z4k</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>,</span> <span class=n>String</span> <span class=n>var2</span><span class=o>,</span> <span class=n>String</span> <span class=n>var3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>,</span> <span class=n>var3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$w3TC5Z4k</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>,</span> <span class=n>String</span> <span class=n>var2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$w3TC5Z4k</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$w3TC5Z4k</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>IMITATE_SUPER_CLASS_PUBLIC：添加超类所有Public修饰的构造器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity$ByteBuddy$AnM1yaqS</span> <span class=kd>extends</span> <span class=n>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$AnM1yaqS</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>,</span> <span class=n>String</span> <span class=n>var2</span><span class=o>,</span> <span class=n>String</span> <span class=n>var3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>,</span> <span class=n>var3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$AnM1yaqS</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>,</span> <span class=n>String</span> <span class=n>var2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$AnM1yaqS</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>IMITATE_SUPER_CLASS_OPENING：添加超类所有可访问的构造器并转换为Public</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity$ByteBuddy$wMHt2jMn</span> <span class=kd>extends</span> <span class=n>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$wMHt2jMn</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>,</span> <span class=n>String</span> <span class=n>var2</span><span class=o>,</span> <span class=n>String</span> <span class=n>var3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>,</span> <span class=n>var3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$wMHt2jMn</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>,</span> <span class=n>String</span> <span class=n>var2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>,</span> <span class=n>var2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$wMHt2jMn</span><span class=o>(</span><span class=n>Long</span> <span class=n>var1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=n>var1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>CreateByConstructorStrategyEntity$ByteBuddy$wMHt2jMn</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=文件保存>文件保存</h3><p>生成类字节码可以进行保存<code>unloaded.saveIn(new File(path));</code>，也就是将你生成的字节码以<code>.class</code>文件保存到相应的位置，但，继承jdk原生类和继承自定义类的保存位置不同。</p><ul><li><p>继承jdk原生类，文件会被保存到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>net.bytebuddy.renamed
</span></span></code></pre></td></tr></table></div></div><p>路径下然后加超类的路径</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>net</span><span class=o>.</span><span class=na>bytebuddy</span><span class=o>.</span><span class=na>renamed</span><span class=o>.</span><span class=na>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Object$ByteBuddy$i0ivrOhL</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>继承用户自定义类，文件被保存和生成类同级路径下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>com</span><span class=o>.</span><span class=na>importzhh</span><span class=o>.</span><span class=na>bytebuddy</span><span class=o>.</span><span class=na>CreateByConstructorStrategyEntity$ByteBuddy$AnM1yaqS</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p>新增一个测试类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>UserService</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;UserService实例化成功&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>queryUser</span><span class=o>(</span><span class=n>String</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;queryUser() is invoked&#34;</span><span class=o>+</span><span class=n>userId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;hello:&#34;</span><span class=o>+</span><span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateUser</span><span class=o>(</span><span class=n>String</span> <span class=n>userId</span><span class=o>,</span> <span class=n>String</span> <span class=n>userName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;updateUser() is invoked&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>deleteUser</span><span class=o>(</span><span class=n>String</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;deleteUser() is invoked&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>foo</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;foo&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>测试字节码保存策略</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ByteBuddyDemo1</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>path</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span> <span class=o>=</span> <span class=n>ByteBuddyDemo1</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getResource</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=na>getPath</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 将字节码保存到文件
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>saveUnloaded</span><span class=o>(</span><span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span><span class=o>,</span> <span class=n>String</span> <span class=n>className</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>FileUtils</span><span class=o>.</span><span class=na>writeByteArrayToFile</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span> <span class=o>+</span> <span class=n>className</span><span class=o>),</span> <span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 对于生成的类的命名规则
</span></span></span><span class=line><span class=cl><span class=cm>     * 1：对于jdk的类   net.bytebuddy.renamed.java.lang.Object$ByteBuddy$QORhkzsm
</span></span></span><span class=line><span class=cl><span class=cm>     * 2：对于自定义的类 org.importzhh.Main$ByteBuddy$vfvp1e2G
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * 指定生成的类的命名策略
</span></span></span><span class=line><span class=cl><span class=cm>     * org.importzhh.Main$suffix$oq9xJ5w5
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test1</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// unloaded 表示生成的字节码还未加载到jvm中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// net.bytebuddy.renamed.java.lang.Object$ByteBuddy$QORhkzsm
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test2</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// unloaded 表示生成的字节码还未加载到jvm中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// org.itstack.Main$ByteBuddy$vfvp1e2G
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test3</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NamingStrategy</span><span class=o>.</span><span class=na>SuffixingRandom</span> <span class=n>suffix</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NamingStrategy</span><span class=o>.</span><span class=na>SuffixingRandom</span><span class=o>(</span><span class=s>&#34;suffix&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// unloaded 表示生成的字节码还未加载到jvm中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 不校验生成的类 默认是校验的
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>TypeValidation</span><span class=o>.</span><span class=na>DISABLED</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>suffix</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// org.itstack.Main$ByteBuddy$vfvp1e2G
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>FileUtils</span><span class=o>.</span><span class=na>writeByteArrayToFile</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span> <span class=o>+</span> <span class=s>&#34;TestMain1.class&#34;</span><span class=o>),</span> <span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//        System.out.println(bytes.length);
</span></span></span><span class=line><span class=cl><span class=c1>//        unloaded.saveIn(new File(path));
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 生成的字节码还可以直接注入到某个jar包中
</span></span></span><span class=line><span class=cl><span class=c1>//        unloaded.inject(new File(&#34;a.jar&#34;));
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=命名策略>命名策略</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>createWithNameStrategy</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NamingStrategy</span><span class=o>.</span><span class=na>SuffixingRandom</span> <span class=n>suffixingRandom</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NamingStrategy</span><span class=o>.</span><span class=na>SuffixingRandom</span><span class=o>(</span><span class=s>&#34;importzhh&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Unloaded代表生成字节码还未加载到jvm
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>suffixingRandom</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//指定父类
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>生成的类名为<code>CreateByConstructorStrategyEntity$importzhh$OnHkVvgk</code>,如果不指定生成策略则生成的类名如下</p><p>超类类名+ByteBuddy+8位随机字符</p><p>增加<code>SuffixingRandom</code>则自定义的后缀将替换<code>ByteBuddy</code>，如果将命名策略改为PrefixingRandom则命名结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>importzhh.com.importzhh.bytebuddy</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>也可以直接指定类名</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>createWithName</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Unloaded代表生成字节码还未加载到jvm
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//指定父类
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=s>&#34;cn.importzhh.NewCreateByConstructorStrategyEntity&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>自定义命名策略</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>createWithSelfDefineNameStrategy</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//使用自定义命名策略
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=k>new</span> <span class=n>NamingStrategy</span><span class=o>.</span><span class=na>AbstractBase</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>protected</span> <span class=n>String</span> <span class=nf>name</span><span class=o>(</span><span class=n>TypeDescription</span> <span class=n>superClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=s>&#34;com.test.&#34;</span> <span class=o>+</span> <span class=n>superClass</span><span class=o>.</span><span class=na>getSimpleName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>})</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>canonicalName</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>()).</span><span class=na>getLoaded</span><span class=o>().</span><span class=na>getCanonicalName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>canonicalName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=字节码注入jar包或指定目录>字节码注入jar包或指定目录</h3><p>也可以将字节码注入到已有的jar中，代码和操作结果如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 从指定目录或jar包中获取类的信息
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IOException
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test9</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//从当前目录下的jar文件中找到类文件。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ClassFileLocator</span> <span class=n>classFileLocator</span> <span class=o>=</span> <span class=n>ClassFileLocator</span><span class=o>.</span><span class=na>ForJarFile</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;/Users/importzhh/.m2/repository/commons-io/commons-io/2.11.0/commons-io-2.11.0.jar&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>//创建一个Compound对象 用于将多个ClassFileLocator组合在一起。这里只有一个ClassFileLocator
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ClassFileLocator</span><span class=o>.</span><span class=na>Compound</span> <span class=n>compound</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ClassFileLocator</span><span class=o>.</span><span class=na>Compound</span><span class=o>(</span><span class=n>classFileLocator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//从compound中获取类的信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>TypePool</span> <span class=n>typePool</span> <span class=o>=</span> <span class=n>TypePool</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>compound</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//获取了&#34;org.apache.commons.io.FileUtils&#34;这个类的描述信息，并解析它。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>TypeDescription</span> <span class=n>typeDescription</span> <span class=o>=</span> <span class=n>typePool</span><span class=o>.</span><span class=na>describe</span><span class=o>(</span><span class=s>&#34;org.apache.commons.io.FileUtils&#34;</span><span class=o>).</span><span class=na>resolve</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>redefine</span><span class=o>(</span><span class=n>typeDescription</span><span class=o>,</span> <span class=n>classFileLocator</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;sizeOf&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>nullValue</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=类加载策略>类加载策略</h3><p>DynamicType.Unloaded，代表一个尚未加载的类，顾名思义，这些类型不会加载到 Java 虚拟机中，它仅仅表示创建好了类的字节码，通过 DynamicType.Unloaded 中的 getBytes 方法你可以获取到该字节码。</p><p>在应用程序中，可能需要将该字节码保存到文件，或者注入的现在的 jar 文件中，因此该类型还提供了一个 saveIn(File) 方法，可以将类存储在给定的文件夹中； inject(File) 方法将类注入到现有的 Jar 文件中，另外你只需要将该字节码直接加载到虚拟机使用，你可以通过 ClassLoadingStrategy 来加载。</p><p><code>ClassLoadingStrategy</code> 是 Byte Buddy 库中用于定义如何加载动态创建或修改的类的策略，内置的策略定义在枚举ClassLoadingStrategy.Default中</p><p>这个策略决定了新生成的类应该被哪个类加载器加载，以及生成的类应该如何与现有的类关联。这里有几种策略：</p><ul><li><p><code>WRAPPER</code>：这个策略表示新生成的类将被与其父类相同的类加载器加载。
在这种策略下，新生成的类不能访问到比其父类更高级的类加载器所加载的类。生成的类只能访问到其父类可以访问到的类。</p></li><li><p><code>WRAPPER_PERSISTENT</code>：这个策略与 <code>WRAPPER</code> 类似，但是它会在类被加载时生成一个类清单（manifest）。
这个清单可以用于在运行时获取关于类的元数据。</p></li><li><p><code>CHILD_FIRST</code>：这个策略表示新生成的类将被一个新的类加载器加载，子加载器优先负责加载目标类
这个新的类加载器将其父类的类加载器作为其父加载器。在这种策略下，新生成的类可以访问到比其父类更高级的类加载器所加载的类。</p></li><li><p><code>CHILD_FIRST_PERSISTENT</code>：这个策略与 <code>CHILD_FIRST</code> 类似，但是它也会在类被加载时生成一个类清单。</p></li><li><p><code>INJECTION</code>：这个策略表示新生成的类将直接被注入到其父类所在的类加载器。利用反射机制注入动态类型
这需要类加载器支持类的动态注入。这些策略的选择取决于你的具体需求。例如，如果你需要新生成的类能够访问到更多的类，
你可能需要选择 <code>CHILD_FIRST</code> 或 <code>CHILD_FIRST_PERSISTENT</code> 策略。如果你不需要这样的功能，
那么 <code>WRAPPER</code> 或 <code>WRAPPER_PERSISTENT</code> 策略可能会是更好的选择。</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dynamicClass</span> <span class=o>=</span> <span class=n>dynamicType</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(),</span> <span class=n>ClassLoadingStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>WRAPPER</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>我们使用 WRAPPER 策略来加载适合大多数情况的类，这样生产的动态类不会被ApplicationClassLoader加载到，不会影响到项目中已经存在的类getLoaded 方法返回一个 Java Class 的实例，它就表示现在加载的动态类</p><h2 id=增强一个类>增强一个类</h2><h3 id=修改方法>修改方法</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 测试继承UserManager 拦截 queryUser 方法 并返回空值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test5</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=s>&#34;a.b.subObjType&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;queryUser&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>nullValue</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>saveUnloaded</span><span class=o>(</span><span class=n>unloaded</span><span class=o>,</span> <span class=s>&#34;TestUserManager1.class&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 测试redefine UserManager queryUser 方法 并返回空值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test6</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>redefine</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=s>&#34;a.b.subObjType&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;queryUser&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>nullValue</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>saveUnloaded</span><span class=o>(</span><span class=n>unloaded</span><span class=o>,</span> <span class=s>&#34;TestUserManager2.class&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=插入方法>插入方法</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 测试bytebuddy向 UserManager 插入一个新方法 testAdd
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test7</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>redefine</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>defineMethod</span><span class=o>(</span><span class=s>&#34;testAdd&#34;</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>+</span><span class=n>Modifier</span><span class=o>.</span><span class=na>STATIC</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>withParameter</span><span class=o>(</span><span class=n>String</span><span class=o>[].</span><span class=na>class</span><span class=o>,</span> <span class=s>&#34;args&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>value</span><span class=o>(</span><span class=s>&#34;这是bytebuddy新增的方法&#34;</span><span class=o>))</span> <span class=c1>//这里是新方法的实现，这里将toString()方法返回固定字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>saveUnloaded</span><span class=o>(</span><span class=n>unloaded</span><span class=o>,</span> <span class=s>&#34;TestUserManager3.class&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=插入属性>插入属性</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向UserManager插入一个新属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test8</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>redefine</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>defineField</span><span class=o>(</span><span class=s>&#34;systemShort&#34;</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PRIVATE</span><span class=o>)</span> <span class=c1>// 定义属性
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>defineMethod</span><span class=o>(</span><span class=s>&#34;getSystemShort&#34;</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>)</span> <span class=c1>// 定义getter方法
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FieldAccessor</span><span class=o>.</span><span class=na>ofField</span><span class=o>(</span><span class=s>&#34;systemShort&#34;</span><span class=o>))</span> <span class=c1>// 指定getter方法返回字段的值
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>defineMethod</span><span class=o>(</span><span class=s>&#34;setSystemShort&#34;</span><span class=o>,</span> <span class=kt>void</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>PUBLIC</span><span class=o>)</span> <span class=c1>// 定义setter方法
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>withParameters</span><span class=o>(</span><span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=c1>// 指定setter方法的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FieldAccessor</span><span class=o>.</span><span class=na>ofField</span><span class=o>(</span><span class=s>&#34;systemShort&#34;</span><span class=o>))</span>  <span class=c1>// 指定setter方法设置字段的值
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>saveUnloaded</span><span class=o>(</span><span class=n>unloaded</span><span class=o>,</span> <span class=s>&#34;TestUserManager4.class&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=增强类>增强类</h3><p>增强一个类有两种方式<code>redefine</code>&<code>rebase</code>，与<code>subclass</code>不同的是这两种方式是在原有类的基础上修改，而<code>subclass</code>是生成一个子类。</p><ul><li>rebase：会保留所有被变基类的方法实现。Byte Buddy 会用兼容的签名复制所有方法的实现为一个私有的重命名过的方法， 而不像类重定义时丢弃覆写的方法。用这种方式的话，不存在方法实现的丢失，而且变基的方法可以通过调用这些重命名的方法， 继续调用原始的方法。</li><li>redifine：允许通过添加字段和方法或者替换已存在的方法实现来修改已存在的类。 但是，如果方法的实现被另一个实现所替换，之前的实现就会丢失。</li></ul><p>使用rebase将之前测试的实体类增加一个getId方法并返回固定值0</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateByConstructorStrategyEntity</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>.....</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Long</span> <span class=nf>getId</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>.....</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后以rebase的方式将其修改，使getId方法的返回值修改</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>dynamicEnhanceByRebase</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=k>new</span> <span class=n>NamingStrategy</span><span class=o>.</span><span class=na>AbstractBase</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>protected</span> <span class=n>String</span> <span class=nf>name</span><span class=o>(</span><span class=n>TypeDescription</span> <span class=n>superClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=s>&#34;top.eacape.&#34;</span> <span class=o>+</span> <span class=n>superClass</span><span class=o>.</span><span class=na>getSimpleName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>})</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>rebase</span><span class=o>(</span><span class=n>CreateByConstructorStrategyEntity</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.&lt;</span><span class=n>MethodDescription</span><span class=o>&gt;</span><span class=n>named</span><span class=o>(</span><span class=s>&#34;getId&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>value</span><span class=o>(</span><span class=mi>50L</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>用idea直接查看没有什么问题，但是查看字节码发现这个文件中还有一个以getId开头的方法，它的返回值为0，代表getId的原始方法
<img src=/p/i-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01/img2013080716400001.png width=639 height=393 srcset="/p/i-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01/img2013080716400001_hu2c9f5f678660b3d3010ca7a01d15c6f8_120453_480x0_resize_box_3.png 480w, /p/i-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01/img2013080716400001_hu2c9f5f678660b3d3010ca7a01d15c6f8_120453_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=162 data-flex-basis=390px></p><p>反观使用redefine就没有这种效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * rebase方式
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * 这种方式表示的是在一个类的方法上重新定义实现（就像是在替换方法中的字节码一样），但保留原来方法的字节码，并且在新方法中调用。
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ByteBuddyDemo2Rebase</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test1</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dynamicType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>rebase</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>MethodDelegation</span><span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=n>InterceptorClass</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>ByteBuddyDemo2Rebase</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>dynamicType</span><span class=o>.</span><span class=na>getDeclaredMethod</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>).</span><span class=na>invoke</span><span class=o>(</span><span class=n>instance</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>InterceptorClass</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>foo</span><span class=o>(</span><span class=nd>@SuperCall</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>zuper</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Before invoking original method&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>zuper</span><span class=o>.</span><span class=na>call</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;After invoking original method&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=匹配方法>匹配方法</h3><h3 id=委托方法>委托方法</h3><p>在大多数情况下，方法返回一个固定值当然是不够的。为了更好的灵活性，Byte Buddy 提供了<code>MethodDelegation(方法委托)</code>实现， 它在对方法调用做出反应时提供最大程度的自由。一个方法委托定义了动态创建的类方法，到另外一个可能存在于动态类型之外的方法的任何调用。 这样，动态类的逻辑可以用简单的 Java 表示，仅通过代码生成就可以与另外的方法绑定。</p><p>实现委托方法有两种，一种是静态方法委托，一种是成员方法委托</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.ByteBuddy</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.MethodDelegation</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.bind.annotation.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.matcher.ElementMatchers</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.itstack.UserService</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.junit.jupiter.api.Test</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.lang.reflect.Method</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.Callable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ByteBuddyDemo3Delegation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     *  在这个例子中，原始的foo方法被插桩并替换为新的MethodInterceptor.intercept方法。
</span></span></span><span class=line><span class=cl><span class=cm>     *  这就是使用ByteBuddy对实例方法进行插桩的一种基本方式。
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *  方法委托 与被拦截方法同签名 且是静态方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test1</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dynamicType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>MethodDelegation</span><span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=n>MethodInterceptor</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getDeclaredConstructor</span><span class=o>().</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span> <span class=n>foo</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>String</span><span class=o>)</span> <span class=n>foo</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>instance</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>  <span class=c1>// prints &#34;intercepted&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     *  在这个例子中，原始的foo方法被插桩并替换为新的MethodInterceptor.intercept方法。
</span></span></span><span class=line><span class=cl><span class=cm>     *  这就是使用ByteBuddy对实例方法进行插桩的一种基本方式。
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *  方法委托 与被拦截方法同签名 且是成员方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test2</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dynamicType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;queryUser&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>MethodDelegation</span><span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=k>new</span> <span class=n>MethodInterceptor2</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getDeclaredConstructor</span><span class=o>().</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span> <span class=n>queryUser</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;queryUser&#34;</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>String</span><span class=o>)</span> <span class=n>queryUser</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>instance</span><span class=o>,</span> <span class=s>&#34;testUserId&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>  <span class=c1>// prints &#34;intercepted&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test3</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dynamicType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;queryUser&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>MethodDelegation</span><span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=k>new</span> <span class=n>MethodInterceptor3</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getDeclaredConstructor</span><span class=o>().</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span> <span class=n>queryUser</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;queryUser&#34;</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>String</span><span class=o>)</span> <span class=n>queryUser</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>instance</span><span class=o>,</span> <span class=s>&#34;testUserId&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>  <span class=c1>// prints &#34;intercepted&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MethodInterceptor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>intercept</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s>&#34;intercepted&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MethodInterceptor2</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>String</span> <span class=nf>intercept</span><span class=o>(</span><span class=n>String</span> <span class=n>userId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s>&#34;intercepted：&#34;</span><span class=o>+</span><span class=n>userId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>class</span> <span class=nc>MethodInterceptor3</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 方法签名或返回值可以与被拦截方法不一致
</span></span></span><span class=line><span class=cl><span class=cm>         * @RuntimeType bytebuddy会在运行期间给被指定注解修饰的方法参数进行赋值
</span></span></span><span class=line><span class=cl><span class=cm>         * @param targetObj        表示被拦截的目标对象 只有拦截实例方法时可用
</span></span></span><span class=line><span class=cl><span class=cm>         * @param targetMethod     表示被拦截的目标方法 只有拦截实例方法或静态方法可用
</span></span></span><span class=line><span class=cl><span class=cm>         * @param targetMethodArgs 目标方法的参数
</span></span></span><span class=line><span class=cl><span class=cm>         * @param targetObj2       被拦截的目标对象 只有拦截实例方法时可用
</span></span></span><span class=line><span class=cl><span class=cm>         *            若确定父类 也可用具体的父类来接收
</span></span></span><span class=line><span class=cl><span class=cm>         * @param zuper            调用目标方法
</span></span></span><span class=line><span class=cl><span class=cm>         * 1. `@RuntimeType`: 这是一个用于方法的注解，用于告知Byte Buddy，此方法在运行时将会被调用。
</span></span></span><span class=line><span class=cl><span class=cm>         *                         该注解通常用于拦截器类的方法，使其成为方法委托的目标。
</span></span></span><span class=line><span class=cl><span class=cm>         * 2. `@This`: 该注解用于注入当前被拦截方法所属的对象（即目标对象）。在拦截器方法中，通过`@This`注解，
</span></span></span><span class=line><span class=cl><span class=cm>         *                         您可以获取目标对象的引用，并在拦截器中使用它。
</span></span></span><span class=line><span class=cl><span class=cm>         * 3. `@Origin`: 该注解用于注入当前被拦截方法的`Method`对象，代表目标方法的反射信息。通过`@Origin`注解，
</span></span></span><span class=line><span class=cl><span class=cm>         *                         您可以获取目标方法的名称、参数列表、返回类型等信息。
</span></span></span><span class=line><span class=cl><span class=cm>         * 4. `@AllArguments`: 该注解用于注入当前被拦截方法的所有参数。在拦截器方法中，通过`@AllArguments`注解，
</span></span></span><span class=line><span class=cl><span class=cm>         *                         您可以获取目标方法的所有参数作为一个对象数组。
</span></span></span><span class=line><span class=cl><span class=cm>         * 5. `@Super`: 该注解用于注入目标方法的父类或父接口实例。通常用于拦截器方法中，使得您可以调用目标方法，而不仅仅是拦截它。
</span></span></span><span class=line><span class=cl><span class=cm>         * 6. `@SuperCall`: 该注解用于注入一个`Callable`对象，代表目标方法的调用。在拦截器方法中，通过`@SuperCall`注解，
</span></span></span><span class=line><span class=cl><span class=cm>         *                         您可以手动调用目标方法，实现方法委托。
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@RuntimeType</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Object</span> <span class=nf>testDelegation</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=nd>@This</span> <span class=n>Object</span> <span class=n>targetObj</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Origin</span> <span class=n>Method</span> <span class=n>targetMethod</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=nd>@AllArguments</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>targetMethodArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Super</span> <span class=n>Object</span> <span class=n>targetObj2</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=nd>@SuperCall</span> <span class=n>Callable</span><span class=o>&lt;?&gt;</span> <span class=n>zuper</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Before calling method: &#34;</span> <span class=o>+</span> <span class=n>targetMethod</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>call</span> <span class=o>=</span> <span class=n>zuper</span><span class=o>.</span><span class=na>call</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;After calling method: &#34;</span> <span class=o>+</span> <span class=n>targetMethod</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的委托方式看起来还是不够灵活，日常最常使用的委托方式是通过注解进行参数绑定。</p><div class=table-wrapper><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Argument</td><td>绑定单个参数</td></tr><tr><td>@AllArguments</td><td>绑定所有参数的数组</td></tr><tr><td>@This</td><td>当前被拦截的、动态生成的那个对象</td></tr><tr><td>@Super</td><td>当前被拦截的、动态生成的那个对象,不会继承原有的类</td></tr><tr><td>@Origin</td><td>可以绑定到以下类型的参数： - Method 被调用的原始方法 - Constructor 被调用的原始构造器 - Class 当前动态创建的类 - MethodHandleMethodTypeString 动态类的toString()的返回值 - int 动态方法的修饰符</td></tr><tr><td>@DefaultCall</td><td>调用默认方法而非super的方法</td></tr><tr><td>@SuperCall</td><td>用于调用父类版本的方法</td></tr><tr><td>@RuntimeType</td><td>可以用在返回值、参数上，提示ByteBuddy禁用严格的类型检查</td></tr><tr><td>@Empty</td><td>注入参数的类型的默认值</td></tr><tr><td>@StubValue</td><td>注入一个存根值。对于返回引用、void的方法，注入null；对于返回原始类型的方法，注入0</td></tr><tr><td>@FieldValue</td><td>注入被拦截对象的一个字段的值</td></tr><tr><td>@Morph</td><td>类似于@SuperCall，但是允许指定调用参数</td></tr></tbody></table></div><p>注意第三种注解方式和之前的委托方法同时存在时，会优先选择前者。</p><h3 id=动态修改参数>动态修改参数</h3><p>前面示例中，使用 @SuperCall 注解注入的 Callable 参数来调用目标方法时，是无法动态修改参数的，如果想要动态修改参数，则需要用到 @Morph 注解以及一些绑定操作，示例如下：</p><p>Interceptor 会使用 @Morph 注解注入一个 OverrideCallable 对象作为参数，然后通过该 OverrideCallable 对象调用目标方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.ByteBuddy</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.dynamic.loading.ClassLoadingStrategy</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.MethodDelegation</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.bind.annotation.AllArguments</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.bind.annotation.Morph</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.bind.annotation.RuntimeType</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.matcher.ElementMatchers</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.junit.jupiter.api.Test</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.lang.reflect.Method</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Arrays</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ByteBuddyDemo5Delegation</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MyInterceptor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@RuntimeType</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Object</span> <span class=nf>modifyParameters</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=nd>@AllArguments</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Morph</span> <span class=n>MyCallable</span> <span class=n>zuper</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Original arguments: &#34;</span> <span class=o>+</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>args</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>args</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=k>instanceof</span> <span class=n>String</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=o>((</span><span class=n>String</span><span class=o>)</span> <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]).</span><span class=na>toUpperCase</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Modified arguments: &#34;</span> <span class=o>+</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>args</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>call</span> <span class=o>=</span> <span class=n>zuper</span><span class=o>.</span><span class=na>call</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>call</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 测试动态修改方法参数
</span></span></span><span class=line><span class=cl><span class=cm>     * @param args
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws Exception
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * `ClassLoadingStrategy` 是 Byte Buddy 库中用于定义如何加载动态创建或修改的类的策略。这个策略决定了新生成的类应该被哪个类加载器加载，以及生成的类应该如何与现有的类关联。这里有几种策略：1. `WRAPPER`：这个策略表示新生成的类将被与其父类相同的类加载器加载。在这种策略下，新生成的类不能访问到比其父类更高级的类加载器所加载的类。2. `WRAPPER_PERSISTENT`：这个策略与 `WRAPPER` 类似，但是它会在类被加载时生成一个类清单（manifest）。这个清单可以用于在运行时获取关于类的元数据。3. `CHILD_FIRST`：这个策略表示新生成的类将被一个新的类加载器加载，这个新的类加载器将其父类的类加载器作为其父加载器。在这种策略下，新生成的类可以访问到比其父类更高级的类加载器所加载的类。4. `CHILD_FIRST_PERSISTENT`：这个策略与 `CHILD_FIRST` 类似，但是它也会在类被加载时生成一个类清单。5. `INJECTION`：这个策略表示新生成的类将直接被注入到其父类所在的类加载器。这需要类加载器支持类的动态注入。这些策略的选择取决于你的具体需求。例如，如果你需要新生成的类能够访问到更多的类，你可能需要选择 `CHILD_FIRST` 或 `CHILD_FIRST_PERSISTENT` 策略。如果你不需要这样的功能，那么 `WRAPPER` 或 `WRAPPER_PERSISTENT` 策略可能会是更好的选择。
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dynamicType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>MyTargetClass</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>named</span><span class=o>(</span><span class=s>&#34;process&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 要用@Morph注解之前，需要通过 Morph.Binder 告诉 Byte Buddy
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 要注入的参数是什么类型
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>MethodDelegation</span><span class=o>.</span><span class=na>withDefaultConfiguration</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>withBinders</span><span class=o>(</span><span class=n>Morph</span><span class=o>.</span><span class=na>Binder</span><span class=o>.</span><span class=na>install</span><span class=o>(</span><span class=n>MyCallable</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=k>new</span> <span class=n>MyInterceptor</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>ByteBuddyDemo5Delegation</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(),</span> <span class=n>ClassLoadingStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>INJECTION</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>MyTargetClass</span> <span class=n>myInstance</span> <span class=o>=</span> <span class=o>(</span><span class=n>MyTargetClass</span><span class=o>)</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getDeclaredConstructor</span><span class=o>().</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Method</span> <span class=n>queryUser</span> <span class=o>=</span> <span class=n>dynamicType</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=s>&#34;process&#34;</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>queryUser</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>myInstance</span><span class=o>,</span> <span class=s>&#34;hello&#34;</span><span class=o>,</span> <span class=s>&#34;world&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MyTargetClass</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>process</span><span class=o>(</span><span class=n>String</span> <span class=n>str1</span><span class=o>,</span> <span class=n>String</span> <span class=n>str2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Processing: &#34;</span> <span class=o>+</span> <span class=n>str1</span> <span class=o>+</span> <span class=s>&#34; &#34;</span> <span class=o>+</span> <span class=n>str2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MyCallable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=nf>call</span><span class=o>(</span><span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=构造器方法>构造器方法</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.ByteBuddy</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.dynamic.DynamicType</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.MethodDelegation</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.SuperMethodCall</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.bind.annotation.RuntimeType</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.implementation.bind.annotation.This</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>net.bytebuddy.matcher.ElementMatchers</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.itstack.UserService</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.junit.jupiter.api.Test</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ByteBuddyDemo6</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 测试拦截构造方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>constructorDelegation</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=n>UserService</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>UserService</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>constructor</span><span class=o>(</span><span class=n>ElementMatchers</span><span class=o>.</span><span class=na>any</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>intercept</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//在构造器方法执行完成之后进行拦截
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>SuperMethodCall</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>.</span><span class=na>andThen</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                                <span class=n>MethodDelegation</span><span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=k>new</span> <span class=n>MethodInterceptor4</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                        <span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>make</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>loaded</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getClassLoader</span><span class=o>()).</span><span class=na>getLoaded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>loaded</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>class</span> <span class=nc>MethodInterceptor4</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@RuntimeType</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>constructorAspect</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=nd>@This</span> <span class=n>Object</span> <span class=n>target</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>target</span> <span class=o>+</span> <span class=s>&#34;：实例化后置操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=常用核心api>常用核心API</h3><ol><li><code>ByteBuddy</code><ul><li>流式API方式的入口类</li><li>提供Subclassing/Redefining/Rebasing方式改写字节码</li><li>所有的操作依赖DynamicType.Builder进行,创建不可变的对象</li></ul></li><li><code>ElementMatchers(ElementMatcher)</code><ul><li>提供一系列的元素匹配的工具类(named/any/nameEndsWith等等)</li><li>ElementMatcher(提供对类型、方法、字段、注解进行matches的方式,类似于Predicate)</li><li>Junction对多个ElementMatcher进行了and/or操作</li></ul></li><li><code>DynamicType</code>(动态类型,所有字节码操作的开始,非常值得关注)<ul><li>Unloaded(动态创建的字节码还未加载进入到虚拟机,需要类加载器进行加载)</li><li>Loaded(已加载到jvm中后,解析出Class表示)</li><li>Default(DynamicType的默认实现,完成相关实际操作)</li></ul></li><li><code>Implementation</code>(用于提供动态方法的实现)<ul><li>FixedValue(方法调用返回固定值)</li><li>MethodDelegation(方法调用委托,支持两种方式: Class的static方法调用、object的instance method方法调用)</li></ul></li><li><code>Builder</code>(用于创建DynamicType,相关接口以及实现后续待详解)<ul><li>MethodDefinition</li><li>FieldDefinition</li><li>AbstractBase</li></ul></li></ol><h2 id=链接>链接</h2><p><a class=link href=https://bytebuddy.net/#/tutorial-cn target=_blank rel=noopener>https://bytebuddy.net/#/tutorial-cn</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/bytebuddy/>bytebuddy</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/ii-bytebuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B02/><div class=article-details><h2 class=article-title>II: ByteBuddy入门笔记2</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 importzhh的小破站</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>