<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="继《面向开发者的ChatGPT提示工程》一课爆火之后，时隔一个月，吴恩达教授再次推出了另外三门免费的AI课程，今天要讲的就是其中联合了 LangChain 一起"><title>I: 基于LangChain的大语言模型应用开发(上)</title><link rel=canonical href=https://blog.importzhh.me/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/><link rel=stylesheet href=/scss/style.min.0d8902b26558cddb5286ea49f2a7aadd5761ed898547e29e5ab572d8c0619ba6.css><meta property="og:title" content="I: 基于LangChain的大语言模型应用开发(上)"><meta property="og:description" content="继《面向开发者的ChatGPT提示工程》一课爆火之后，时隔一个月，吴恩达教授再次推出了另外三门免费的AI课程，今天要讲的就是其中联合了 LangChain 一起"><meta property="og:url" content="https://blog.importzhh.me/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/"><meta property="og:site_name" content="importzhh的小破站"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="LangChain"><meta property="article:published_time" content="2023-08-29T12:44:47+08:00"><meta property="article:modified_time" content="2023-08-29T12:44:47+08:00"><meta name=twitter:title content="I: 基于LangChain的大语言模型应用开发(上)"><meta name=twitter:description content="继《面向开发者的ChatGPT提示工程》一课爆火之后，时隔一个月，吴恩达教授再次推出了另外三门免费的AI课程，今天要讲的就是其中联合了 LangChain 一起"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huce6e906a97de2553354850eae15a0392_8624_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>importzhh的小破站</a></h1><h2 class=site-description>实事求是 思危思退思变</h2></div></header><ol class=social-menu><li><a href=https://github.com/importzhh target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="-1.65 0 259.3 259.3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"><g><path fill="#9edcf2" d="M200.9 199.8c0 13.9-32.2 25.1-71.9 25.1-39.7.0-71.9-11.3-71.9-25.1.0-13.9 32.2-25.1 71.9-25.1C168.7 174.7 200.9 185.9 200.9 199.8zm0 0"/><g><defs><path id="SVGID_1_" d="M98.1 244.8c1.6 7.5 5.5 11.9 9.4 14.5h41.1c5-3.4 10.1-9.8 10.1-21.8v-31s.6-7.7 7.7-10.2c0 0 4.1-2.9-.3-4.5.0.0-19.5-1.6-19.5 14.4v23.6s.8 8.7-3.8 12.3v-29.2s.3-9.3 5.1-12.8c0 0 3.2-5.7-3.8-4.2.0.0-13.4 1.9-14 17.6l-.3 30h-3.2l-.3-30c-.6-15.6-14-17.6-14-17.6-7-1.6-3.8 4.2-3.8 4.2 4.8 3.5 5.1 12.8 5.1 12.8v29.5c-4.6-3.3-3.8-12.6-3.8-12.6v-23.6c0-16-19.5-14.4-19.5-14.4-4.5 1.6-.3 4.5-.3 4.5 7 2.6 7.7 10.2 7.7 10.2v21.7L98.1 244.8z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" overflow="visible"/></clipPath><path clip-path="url(#SVGID_2_)" fill="#7dbce7" d="M200.9 199.8c0 13.9-32.2 25.1-71.9 25.1-39.7.0-71.9-11.3-71.9-25.1.0-13.9 32.2-25.1 71.9-25.1C168.7 174.7 200.9 185.9 200.9 199.8zm0 0"/></g><path fill="#9edcf2" d="M46.9 125.9l-2.1 7.2s-.5 2.6 1.9 3.1c2.6-.1 2.4-2.5 2.2-3.2L46.9 125.9zm0 0"/><path fill="#010101" d="M255.8 95.6l.2-.9c-21.1-4.2-42.7-4.3-55.8-3.7 2.1-7.7 2.8-16.7 2.8-26.6.0-14.3-5.4-25.7-14-34.3 1.5-4.9 3.5-15.8-2-29.7.0.0-9.8-3.1-32.1 11.8-8.7-2.2-18-3.3-27.3-3.3-10.2.0-20.5 1.3-30.2 3.9C74.4-2.9 64.3.3 64.3.3c-6.6 16.5-2.5 28.8-1.3 31.8-7.8 8.4-12.5 19.1-12.5 32.2.0 9.9 1.1 18.8 3.9 26.5-13.2-.5-34-.3-54.4 3.8l.2.9c20.4-4.1 41.4-4.2 54.5-3.7.6 1.6 1.3 3.2 2 4.7-13 .4-35.1 2.1-56.3 8.1l.3.9c21.4-6 43.7-7.6 56.6-8 7.8 14.4 23 23.8 50.2 26.7-3.9 2.6-7.8 7-9.4 14.5-5.3 2.5-21.9 8.7-31.9-8.5.0.0-5.6-10.2-16.3-11 0 0-10.4-.2-.7 6.5.0.0 6.9 3.3 11.7 15.6.0.0 6.3 21 36.4 14.2V177s-.6 7.7-7.7 10.2c0 0-4.2 2.9.3 4.5.0.0 19.5 1.6 19.5-14.4v-23.6s-.8-9.4 3.8-12.6v38.8s-.3 9.3-5.1 12.8c0 0-3.2 5.7 3.8 4.2.0.0 13.4-1.9 14-17.6l.3-39.3h3.2l.3 39.3c.6 15.6 14 17.6 14 17.6 7 1.6 3.8-4.2 3.8-4.2-4.8-3.5-5.1-12.8-5.1-12.8v-38.5c4.6 3.6 3.8 12.3 3.8 12.3v23.6c0 16 19.5 14.4 19.5 14.4 4.5-1.6.3-4.5.3-4.5-7-2.6-7.7-10.2-7.7-10.2v-31c0-12.1-5.1-18.5-10.1-21.8 29-2.9 42.9-12.2 49.3-26.8 12.7.3 35.6 1.9 57.4 8.1l.3-.9c-21.7-6.1-44.4-7.7-57.3-8.1.6-1.5 1.1-3 1.6-4.6C212.9 91.4 234.6 91.4 255.8 95.6zm0 0"/><path fill="#f5ccb3" d="M174.6 63.7c6.2 5.7 9.9 12.5 9.9 19.8.0 34.4-25.6 35.3-57.2 35.3S70.1 114 70.1 83.5c0-7.3 3.6-14.1 9.8-19.7 10.3-9.4 27.7-4.4 47.4-4.4 19.7.0 37-5.1 47.3 4.3zm0 0"/><path fill="#fff" d="M108.3 85.3c0 9.5-5.3 17.1-11.9 17.1-6.6.0-11.9-7.7-11.9-17.1.0-9.5 5.3-17.1 11.9-17.1C103 68.1 108.3 75.8 108.3 85.3zm0 0"/><path fill="#af5c51" d="M104.5 85.5c0 6.3-3.6 11.4-7.9 11.4-4.4.0-7.9-5.1-7.9-11.4.0-6.3 3.6-11.4 7.9-11.4S104.5 79.2 104.5 85.5zm0 0"/><path fill="#fff" d="M172.2 85.3c0 9.5-5.3 17.1-11.9 17.1s-11.9-7.7-11.9-17.1c0-9.5 5.3-17.1 11.9-17.1C166.8 68.1 172.2 75.8 172.2 85.3zm0 0"/><path fill="#af5c51" d="M168.3 85.5c0 6.3-3.6 11.4-7.9 11.4-4.4.0-7.9-5.1-7.9-11.4.0-6.3 3.6-11.4 7.9-11.4C164.8 74.1 168.3 79.2 168.3 85.5zm0 0"/><path fill="#af5c51" d="M130.5 100.5c0 1.6-1.3 3-3 3-1.6.0-3-1.3-3-3s1.3-3 3-3c1.59999999999999.0 3 1.3 3 3zm0 0"/><path fill="#af5c51" d="M120.6 108c-.2-.5.1-1 .6-1.2s1 .1 1.2.6c.8 2.2 2.8 3.6 5.1 3.6s4.3-1.5 5.1-3.6c.2-.5.7-.8 1.2-.6s.8.7.6 1.2c-1 2.9-3.8 4.9-6.9 4.9C124.4 112.9 121.6 110.9 120.6 108zm0 0"/><path fill="#c4e5d9" d="M54.5 121.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4.0-.8.9-1.4 2.1-1.4C53.6 120.2 54.5 120.8 54.5 121.6zm0 0"/><path fill="#c4e5d9" d="M60.3 124.8c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4.0-.8.9-1.4 2.1-1.4C59.4 123.4 60.3 124 60.3 124.8zm0 0"/><path fill="#c4e5d9" d="M63.8 129c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C62.9 127.5 63.8 128.2 63.8 129zm0 0"/><path fill="#c4e5d9" d="M67 133.8c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C66.1 132.3 67 133 67 133.8zm0 0"/><path fill="#c4e5d9" d="M70.5 138.2c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C69.6 136.8 70.5 137.4 70.5 138.2zm0 0"/><path fill="#c4e5d9" d="M75.3 142.1c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C74.4 140.6 75.3 141.3 75.3 142.1zm0 0"/><path fill="#c4e5d9" d="M82 144.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4S82 143.8 82 144.6zm0 0"/><path fill="#c4e5d9" d="M88.7 144.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4S88.7 143.8 88.7 144.6zm0 0"/><path fill="#c4e5d9" d="M95.5 143.5c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C94.5 142.1 95.5 142.7 95.5 143.5zm0 0"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#介绍>介绍</a><ol><li><a href=#langchain是什么>LangChain是什么？</a></li><li><a href=#langchain做了什么工作>LangChain做了什么工作？</a></li><li><a href=#langchain有什么特点>LangChain有什么特点？</a></li></ol></li><li><a href=#模型提示与输出解析>模型、提示与输出解析</a></li><li><a href=#直接调用api-vs-使用langchain>直接调用API vs 使用LangChain</a><ol><li><a href=#直接调用api>直接调用API</a><ol><li><a href=#步骤1定义辅助函数用于调用openai-api>步骤1：定义辅助函数，用于调用OpenAI API</a></li><li><a href=#步骤2定义待翻译文本与翻译风格>步骤2：定义待翻译文本与翻译风格</a></li><li><a href=#步骤3定义提示用于指定目标语言并以字符串插值的形式插入文本与风格>步骤3：定义提示，用于指定目标语言，并以字符串插值的形式插入文本与风格</a></li><li><a href=#步骤4调用函数并打印结果>步骤4：调用函数并打印结果</a></li></ol></li><li><a href=#使用langchain>使用LangChain</a><ol><li><a href=#步骤1创建chatopenai实例>步骤1：创建ChatOpenAI实例</a></li><li><a href=#步骤2创建提示模板实例>步骤2：创建提示模板实例</a></li><li><a href=#步骤3定义翻译风格与待翻译文本作为输入变量传入提示模板>步骤3：定义翻译风格与待翻译文本，作为输入变量传入提示模板</a></li><li><a href=#步骤4调用llm翻译成指定风格并打印结果>步骤4：调用LLM翻译成指定风格，并打印结果</a></li></ol></li><li><a href=#为什么要使用提示模板>为什么要使用提示模板？</a></li></ol></li><li><a href=#langchain输出解析器的作用>LangChain输出解析器的作用</a><ol><li><ol><li><a href=#步骤1指定返回的json的格式规范>步骤1：指定返回的JSON的格式规范</a></li><li><a href=#步骤2创建解析器实例获取格式指令>步骤2：创建解析器实例，获取格式指令</a></li><li><a href=#步骤3创建提示模板实例将文本和格式指令作为输入变量传入>步骤3：创建提示模板实例，将文本和格式指令作为输入变量传入</a></li></ol></li><li><a href=#步骤4调用llm解析文本并打印结果>步骤4：调用LLM解析文本，并打印结果</a></li><li><a href=#步骤5将结果解析为字典类型并提取与送货天数相关联的值>步骤5：将结果解析为字典类型，并提取与送货天数相关联的值</a></li></ol></li><li><a href=#记忆memory>记忆(Memory)</a></li><li><a href=#conversationbuffermemory>ConversationBufferMemory</a><ol><li><ol><li><a href=#步骤1创建对话链实例>步骤1：创建对话链实例</a></li><li><a href=#步骤2使用conversationpredict函数进行对话>步骤2：使用"conversation.predict"函数进行对话</a></li><li><a href=#步骤3打印当前对话存储的所有历史消息>步骤3：打印当前对话存储的所有历史消息</a></li></ol></li></ol></li><li><a href=#conversationbufferwindowmemory>ConversationBufferWindowMemory</a></li><li><a href=#conversationaltokenbuffermemory>ConversationalTokenBufferMemory</a></li><li><a href=#conversationsummarybuffermemory>ConversationSummaryBufferMemory</a></li><li><a href=#其他记忆存储管理策略>其他记忆存储管理策略</a></li><li><a href=#链>链</a></li><li><a href=#llm链llmchain>LLM链（LLMChain）</a><ol><li><ol><li><a href=#步骤1初始化语言模型和提示>步骤1：初始化语言模型和提示</a></li><li><a href=#步骤2将产品传入链中并运行链>步骤2：将产品传入链中，并运行链</a></li></ol></li></ol></li><li><a href=#简单顺序链simplesequentialchain>简单顺序链（SimpleSequentialChain）</a><ol><li><ol><li><a href=#步骤1初始化语言模型>步骤1：初始化语言模型</a></li><li><a href=#步骤2创建第一个链>步骤2：创建第一个链</a></li><li><a href=#步骤3创建第二个链>步骤3：创建第二个链</a></li><li><a href=#步骤4创建简单顺序链实例并运行链>步骤4：创建简单顺序链实例，并运行链</a></li></ol></li></ol></li><li><a href=#常规顺序链sequentialchain>常规顺序链（SequentialChain）</a><ol><li><ol><li><a href=#步骤1初始化语言模型-1>步骤1：初始化语言模型</a></li><li><a href=#步骤2创建一堆将依次使用的链>步骤2：创建一堆将依次使用的链</a></li><li><a href=#步骤3将这些链组合在顺序链中并指定输入与输出变量>步骤3：将这些链组合在顺序链中，并指定输入与输出变量</a></li><li><a href=#步骤4选择一条评论并将其传递到整个链中>步骤4：选择一条评论并将其传递到整个链中</a></li></ol></li></ol></li><li><a href=#路由链routerchain>路由链（RouterChain）</a><ol><li><ol><li><a href=#步骤1提供多个特定类型的提示模板>步骤1：提供多个特定类型的提示模板</a></li><li><a href=#步骤2为每个提示模板提供更多相关信息>步骤2：为每个提示模板提供更多相关信息</a></li><li><a href=#步骤3导入需要的链类型定义使用的语言模型>步骤3：导入需要的链类型，定义使用的语言模型</a></li><li><a href=#步骤4创建目标链>步骤4：创建目标链</a></li><li><a href=#步骤5创建默认链>步骤5：创建默认链</a></li><li><a href=#步骤6定义一个路由提示模板>步骤6：定义一个路由提示模板</a></li><li><a href=#步骤7组合语言模型路由提示模板构成路由链>步骤7：组合语言模型、路由提示模板，构成路由链</a></li><li><a href=#步骤8组合路由链目标链和默认链创建整条链>步骤8：组合路由链、目标链和默认链，创建整条链</a></li><li><a href=#步骤9提问不同类型的问题>步骤9：提问不同类型的问题</a></li></ol></li></ol></li><li><a href=#相关链接>相关链接</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/chatgpt/>chatgpt</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/>I: 基于LangChain的大语言模型应用开发(上)</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Aug 29, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 16 分钟</time></div></footer></div></header><section class=article-content><p>继《面向开发者的ChatGPT提示工程》一课爆火之后，时隔一个月，吴恩达教授再次推出了另外三门免费的AI课程，今天要讲的就是其中联合了 LangChain 一起授课的——《基于LangChain的大语言模型应用开发》。</p><p>这门课程将系统地介绍 LangChain 的常见组件及其应用，包括：</p><ul><li>模型，提示和输出解析（第1章节）</li><li>记忆（第2章节）</li><li>链（第3章节）</li><li>基于文档的问答（第4章节）</li><li>评估（第5章节）</li><li>代理（第6章节）</li></ul><p>在线观看链接：<a class=link href=%22https://www.deeplearning.ai/short-courses/langchain-for-llm-application-development/%22>https://www.deeplearning.ai/</a></p><div class=video-wrapper><iframe src="https://player.bilibili.com/player.html?as_wide=1&amp;high_quality=1&amp;page=1&bvid=BV1zu4y1Z7mc" scrolling=no frameborder=no framespacing=0 allowfullscreen></iframe></div><h2 id=介绍>介绍</h2><h3 id=langchain是什么>LangChain是什么？</h3><p>一个开源的、用于构建LLM应用的开发框架。</p><h3 id=langchain做了什么工作>LangChain做了什么工作？</h3><p>虽然通过提示（Prompt），可以加速开发LLM应用的进程，但过程中可能会产生很多胶水代码。</p><p>LangChain所做的，就是<strong>把其中一些公共的部分抽象出来</strong>。</p><h3 id=langchain有什么特点>LangChain有什么特点？</h3><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.09.19.png width=1218 height=792 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.09.19_hu735320dc350694b53f27ad438b98daf4_240133_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.09.19_hu735320dc350694b53f27ad438b98daf4_240133_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=153 data-flex-basis=369px></p><p><strong>LangChain注重组合和模块化</strong>。</p><p>LangChain拥有许多独立组件，可以单独使用，也可以与其他组件组合使用。</p><p>通过将模块化的组件链式组合，可以构建一个更完整的应用程序。</p><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.18.21.png width=2564 height=1374 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.18.21_hu3be2ac64ab509db36ae966eb92e60995_908875_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.18.21_hu3be2ac64ab509db36ae966eb92e60995_908875_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=186 data-flex-basis=447px></p><h2 id=模型提示与输出解析>模型、提示与输出解析</h2><p>先理清几个概念：</p><div class=table-wrapper><table><thead><tr><th>概念</th><th>解释</th></tr></thead><tbody><tr><td>模型</td><td>语言模型，用于生成文本。</td></tr><tr><td>提示</td><td>用于向模型传递信息。</td></tr><tr><td>解析器</td><td>接收模型的输出，并将其解析成更结构化的格式。</td></tr></tbody></table></div><p>LangChain提供了一套简单的抽象，用于简化原先需要对模型反复提示与解析的操作。</p><h2 id=直接调用api-vs-使用langchain>直接调用API vs 使用LangChain</h2><p>使用LangChain访问ChatGPT，与直接使用OpenAI API有什么区别？让我们用一个例子来对比一下。</p><p>任务是将文本按指定风格翻译成目标语言。</p><h3 id=直接调用api>直接调用API</h3><h4 id=步骤1定义辅助函数用于调用openai-api>步骤1：定义辅助函数，用于调用OpenAI API</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_completion</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}]</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>openai</span><span class=o>.</span><span class=n>ChatCompletion</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=o>=</span><span class=n>messages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2定义待翻译文本与翻译风格>步骤2：定义待翻译文本与翻译风格</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 文本</span>
</span></span><span class=line><span class=cl><span class=n>customer_email</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Arrr, I be fuming that me blender lid </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>flew off and splattered me kitchen walls </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>with smoothie! And to make matters worse,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>the warranty don&#39;t cover the cost of </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>cleaning up me kitchen. I need yer help </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>right now, matey!
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 风格</span>
</span></span><span class=line><span class=cl><span class=n>style</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;American English </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>in a calm and respectful tone
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3定义提示用于指定目标语言并以字符串插值的形式插入文本与风格>步骤3：定义提示，用于指定目标语言，并以字符串插值的形式插入文本与风格</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Translate the text </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>that is delimited by triple backticks 
</span></span></span><span class=line><span class=cl><span class=s2>into a style that is </span><span class=si>{</span><span class=n>style</span><span class=si>}</span><span class=s2>.
</span></span></span><span class=line><span class=cl><span class=s2>text: ```</span><span class=si>{</span><span class=n>customer_email</span><span class=si>}</span><span class=s2>```
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4调用函数并打印结果>步骤4：调用函数并打印结果</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>get_completion</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=使用langchain>使用LangChain</h3><h4 id=步骤1创建chatopenai实例>步骤1：创建ChatOpenAI实例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 导入ChatOpenAI，这是LangChain对ChatGPT API访问的抽象</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chat_models</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=c1># 要控制 LLM 生成文本的随机性和创造性，请使用 temperature = 0.0</span>
</span></span><span class=line><span class=cl><span class=n>chat</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2创建提示模板实例>步骤2：创建提示模板实例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 模板字符串，用于指定目标语言，拥有两个输入变量，&#34;style&#34;和&#34;text&#34;</span>
</span></span><span class=line><span class=cl><span class=n>template_string</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;Translate the text </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>that is delimited by triple backticks </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>into a style that is </span><span class=si>{style}</span><span class=s2>. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>text: ```</span><span class=si>{text}</span><span class=s2>```
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 构建一个ChatPromptTemplate实例，用于模板的重用</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=n>prompt_template</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=n>template_string</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3定义翻译风格与待翻译文本作为输入变量传入提示模板>步骤3：定义翻译风格与待翻译文本，作为输入变量传入提示模板</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 风格</span>
</span></span><span class=line><span class=cl><span class=n>customer_style</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;American English </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>in a calm and respectful tone
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 文本</span>
</span></span><span class=line><span class=cl><span class=n>customer_email</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Arrr, I be fuming that me blender lid </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>flew off and splattered me kitchen walls </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>with smoothie! And to make matters worse, </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>the warranty don&#39;t cover the cost of </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>cleaning up me kitchen. I need yer help </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>right now, matey!
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将风格和文本作为输入变量传入提示模板</span>
</span></span><span class=line><span class=cl><span class=n>customer_messages</span> <span class=o>=</span> <span class=n>prompt_template</span><span class=o>.</span><span class=n>format_messages</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>style</span><span class=o>=</span><span class=n>customer_style</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>text</span><span class=o>=</span><span class=n>customer_email</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4调用llm翻译成指定风格并打印结果>步骤4：调用LLM翻译成指定风格，并打印结果</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>customer_response</span> <span class=o>=</span> <span class=n>chat</span><span class=p>(</span><span class=n>customer_messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>customer_response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，使用LangChain访问ChatGPT，与直接使用OpenAI API相比，主要区别是：</p><ul><li>对ChatGPT API的访问做了抽象，简化调用</li><li>改用提示模板，而不是"f"字符串，方便重用</li></ul><h3 id=为什么要使用提示模板>为什么要使用提示模板？</h3><p>随着构建应用程序的复杂度增加时，提示可能会需要更长且更详细。</p><p><strong>提示模板作为一种抽象，可以让我们适时重用提示</strong>。</p><p>此外，LangChain还为一些常见操作提供了提示，如摘要、回答问题、连接到SQL数据库或连接到不同的API。</p><p>通过使用LangChain的内置提示，可以快速地使应用程序运行，而无需设计自己的提示。</p><h2 id=langchain输出解析器的作用>LangChain输出解析器的作用</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.29.32.png width=1544 height=1508 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.29.32_hu8a097bdeec505056b142e7ca9c926294_1166905_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.29.32_hu8a097bdeec505056b142e7ca9c926294_1166905_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=102 data-flex-basis=245px></p><p><strong>输出解析器可以提取模型输出中的特定字段，解析为更易于处理的格式</strong>。</p><p>比如，解析为 Python 字典：</p><h4 id=步骤1指定返回的json的格式规范>步骤1：指定返回的JSON的格式规范</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.output_parsers</span> <span class=kn>import</span> <span class=n>ResponseSchema</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.output_parsers</span> <span class=kn>import</span> <span class=n>StructuredOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 礼物规范</span>
</span></span><span class=line><span class=cl><span class=n>gift_schema</span> <span class=o>=</span> <span class=n>ResponseSchema</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;gift&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Was the item purchased</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                             as a gift for someone else? </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                             Answer True if yes,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                             False if not or unknown.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 送货日期规范</span>
</span></span><span class=line><span class=cl><span class=n>delivery_days_schema</span> <span class=o>=</span> <span class=n>ResponseSchema</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;delivery_days&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>description</span><span class=o>=</span><span class=s2>&#34;How many days</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                      did it take for the product</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                      to arrive? If this </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                      information is not found,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                      output -1.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 价格值规范</span>
</span></span><span class=line><span class=cl><span class=n>price_value_schema</span> <span class=o>=</span> <span class=n>ResponseSchema</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;price_value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Extract any</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                    sentences about the value or </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                    price, and output them as a </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>                                    comma separated Python list.&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2创建解析器实例获取格式指令>步骤2：创建解析器实例，获取格式指令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 将格式规范放到一个列表里</span>
</span></span><span class=line><span class=cl><span class=n>response_schemas</span> <span class=o>=</span> <span class=p>[</span><span class=n>gift_schema</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>delivery_days_schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>price_value_schema</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># 构建一个StructuredOutputParser实例</span>
</span></span><span class=line><span class=cl><span class=n>output_parser</span> <span class=o>=</span> <span class=n>StructuredOutputParser</span><span class=o>.</span><span class=n>from_response_schemas</span><span class=p>(</span><span class=n>response_schemas</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 获取将发送给LLM的格式指令</span>
</span></span><span class=line><span class=cl><span class=n>format_instructions</span> <span class=o>=</span> <span class=n>output_parser</span><span class=o>.</span><span class=n>get_format_instructions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>format_instructions</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>格式指令用于让LLM生成指定的内容格式，以便解析器可以解析，打印得到其内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &#34;\`\`\`json&#34; and &#34;\`\`\`&#34;:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>```json
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>&#34;gift&#34;: string  // Was the item purchased as a gift for someone else? Answer True if yes, False if not or unknown.
</span></span><span class=line><span class=cl>&#34;delivery_days&#34;: string  // How many days did it take for the product to arrive? If this information is not found,                                      output -1.
</span></span><span class=line><span class=cl>&#34;price_value&#34;: string  // Extract any sentences about the value or price, and output them as a comma separated Python list.
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>\```
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3创建提示模板实例将文本和格式指令作为输入变量传入>步骤3：创建提示模板实例，将文本和格式指令作为输入变量传入</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 提示</span>
</span></span><span class=line><span class=cl><span class=n>review_template_2</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>For the following text, extract the following information:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>gift: Was the item purchased as a gift for someone else? </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>Answer True if yes, False if not or unknown.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>delivery_days: How many days did it take for the product</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>to arrive? If this information is not found, output -1.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>price_value: Extract any sentences about the value or price,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>and output them as a comma separated Python list.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>text: </span><span class=si>{text}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{format_instructions}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建一个ChatPromptTemplate实例，用于模板的重用</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=n>template</span><span class=o>=</span><span class=n>review_template_2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 将文本和格式指令作为输入变量传入</span>
</span></span><span class=line><span class=cl><span class=n>messages</span> <span class=o>=</span> <span class=n>prompt</span><span class=o>.</span><span class=n>format_messages</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=n>customer_review</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                <span class=n>format_instructions</span><span class=o>=</span><span class=n>format_instructions</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=步骤4调用llm解析文本并打印结果>步骤4：调用LLM解析文本，并打印结果</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>chat</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>打印结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>```</span><span class=n>json</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;gift&#34;</span><span class=p>:</span> <span class=n>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;delivery_days&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;price_value&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;It&#39;s slightly more expensive than the other leaf blowers out there, but I think it&#39;s worth it for the extra features.&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>\<span class=err>```</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=步骤5将结果解析为字典类型并提取与送货天数相关联的值>步骤5：将结果解析为字典类型，并提取与送货天数相关联的值</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>output_dict</span> <span class=o>=</span> <span class=n>output_parser</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>output_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;delivery_days&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>提取到的值如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#39;2&#39;
</span></span></code></pre></td></tr></table></div></div><h2 id=记忆memory>记忆(Memory)</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.32.58.png width=1286 height=1636 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.32.58_hu7ea1315de7147e74b2875cf34fcfb480_765235_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.32.58_hu7ea1315de7147e74b2875cf34fcfb480_765235_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=78 data-flex-basis=188px></p><p>当我们与模型互动时，由于模型本身是无状态的，因此它通常无法记住之前对话的历史消息。</p><p>每个请求交互，每次调用API都是独立的，这对于构建流畅的对话应用是个问题。</p><p>为此，LangChain提供了多种记忆存储管理策略。</p><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.32.13.png width=1264 height=1358 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.32.13_hu9665565be476273cf2c1f5198a903ab7_466143_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.32.13_hu9665565be476273cf2c1f5198a903ab7_466143_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=93 data-flex-basis=223px></p><div class=table-wrapper><table><thead><tr><th>策略</th><th>特点</th></tr></thead><tbody><tr><td>ConversationBufferMemory</td><td>存储完整的对话历史</td></tr><tr><td>ConversationBufferWindowMemory</td><td>只保留最后几轮对话</td></tr><tr><td>ConversationalTokenBufferMemory</td><td>限制存储的令牌数量</td></tr><tr><td>ConversationSummaryBufferMemory</td><td>使用摘要存储对话历史</td></tr></tbody></table></div><h2 id=conversationbuffermemory>ConversationBufferMemory</h2><p>ConversationBufferMemory可用于临时存储完整的对话历史。</p><p>例子如下：</p><h4 id=步骤1创建对话链实例>步骤1：创建对话链实例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chat_models</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains</span> <span class=kn>import</span> <span class=n>ConversationChain</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.memory</span> <span class=kn>import</span> <span class=n>ConversationBufferMemory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>ConversationBufferMemory</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>conversation</span> <span class=o>=</span> <span class=n>ConversationChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>memory</span> <span class=o>=</span> <span class=n>memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2使用conversationpredict函数进行对话>步骤2：使用"conversation.predict"函数进行对话</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;Hi, my name is Andrew&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;What is 1+1?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;What is my name?&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>也可使用"memory.save_context"直接往存储里添加新内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;Not much, just hanging&#34;</span><span class=p>},</span> 
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Cool&#34;</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>由于我们把"verbose"变量改成"True，因此可以看到LangChain运行时的更多细节：</p><blockquote><p>> Entering new ConversationChain chain&mldr;</p><p>Prompt after formatting:</p><p>The following is a friendly conversation between a human and an AI. The AI is talkative and provides lots of specific details from its context. If the AI does not know the answer to a question, it truthfully says it does not know.</p><p>Current conversation:</p><p>Human: Hi, my name is Andrew</p><p>AI: Hello Andrew, it&rsquo;s nice to meet you. My name is AI. How can I assist you today?</p><p>Human: What is 1+1?</p><p>AI: The answer to 1+1 is 2.</p><p>Human: What is my name?</p><p>AI:</p><p>> Finished chain.</p><p>&lsquo;Your name is Andrew, as you mentioned earlier.&rsquo;</p></blockquote><p>可以看到，记忆存储包含了到目前为止的所有对话消息，并用作LLM的输入或额外上下文。</p><p>这样，它在生成输出时，就可以基于之前所说过的会话内容，再生成新的会话，让你感觉它好像“记得”你说过的话。</p><h4 id=步骤3打印当前对话存储的所有历史消息>步骤3：打印当前对话存储的所有历史消息</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>memory</span><span class=o>.</span><span class=n>buffer</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Human: Hi, my name is Andrew</p><p>AI: Hello Andrew, it&rsquo;s nice to meet you. My name is AI. How can I assist you today?</p><p>Human: What is 1+1?</p><p>AI: The answer to 1+1 is 2.</p><p>Human: What is my name?</p><p>AI: Your name is Andrew, as you mentioned earlier.</p></blockquote><p>或者，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>memory</span><span class=o>.</span><span class=n>load_memory_variables</span><span class=p>({}))</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>{&lsquo;history&rsquo;: &ldquo;Human: Hi, my name is Andrew\nAI: Hello Andrew, it&rsquo;s nice to meet you. My name is AI. How can I assist you today?\nHuman: What is 1+1?\nAI: The answer to 1+1 is 2.\nHuman: What is my name?\nAI: Your name is Andrew, as you mentioned earlier.&rdquo;}</p></blockquote><p>但随着对话的进行，记忆存储的大小会增加，发送Token的成本也会增加，为此，LangChain提供了另外几种策略。</p><h2 id=conversationbufferwindowmemory>ConversationBufferWindowMemory</h2><p>ConversationBufferWindowMemory只保留窗口记忆，也即只保留最后几轮对话。它有一个变量k，表示想记住最后几轮对话。</p><p>比如，当k等于1时，表示仅记住最后一轮对话。</p><p>例子如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.memory</span> <span class=kn>import</span> <span class=n>ConversationBufferWindowMemory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>ConversationBufferWindowMemory</span><span class=p>(</span><span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conversation</span> <span class=o>=</span> <span class=n>ConversationChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>memory</span> <span class=o>=</span> <span class=n>memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以在进行几轮对话之后，尝试让其回顾之前的对话内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;Hi, my name is Andrew&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;Hello Andrew, it&#39;s nice to meet you. My name is AI. How can I assist you today?&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;What is 1+1?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;The answer to 1+1 is 2.&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;What is my name?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;I&#39;m sorry, I don&#39;t have access to that information. Could you please tell me your name?&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>这时我们会发现，由于窗口记忆的限制，它会丢失了前面有关名字的交流，从而无法说出我的名字。</p><p>这个功能可以防止记忆存储量随着对话的进行而无限增长。当然在实际使用时，k不会设为1，而是会通常设置为一个较大的数字。</p><h2 id=conversationaltokenbuffermemory>ConversationalTokenBufferMemory</h2><p>很多LLM定价是基于Token的，Token调用的数量直接反映了LLM调用的成本。</p><p>使用ConversationalTokenBufferMemory，可以限制保存在记忆存储的令牌数量。</p><p>例子如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.memory</span> <span class=kn>import</span> <span class=n>ConversationTokenBufferMemory</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.llms</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定LLM和Token限制值</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>ConversationTokenBufferMemory</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>max_token_limit</span><span class=o>=</span><span class=mi>30</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在插入一些消息之后，我们可以打印其实际保存的历史消息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 插入一些消息</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;AI is what?!&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Amazing!&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;Backpropagation is what?&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Beautiful!&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;Chatbots are what?&#34;</span><span class=p>},</span> 
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Charming!&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印历史消息</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>load_memory_variables</span><span class=p>({})</span>
</span></span></code></pre></td></tr></table></div></div><p>打印内容如下：</p><blockquote><p>{&lsquo;history&rsquo;: &lsquo;AI: Beautiful!\nHuman: Chatbots are what?\nAI: Charming!&rsquo;}</p></blockquote><p>我们会发现，当把Token限制值调得比较高时，它几乎可以包含整个对话。</p><p><strong>而如果减少值，它会删掉对话最早的那部分消息，只保留最近对话的消息，并且保证总的消息内容长度不超过Token限制值</strong>。</p><p>另外，之所以还要指定一个LLM参数，是因为不同的LLM使用不同的Token计算方式。</p><p>这里是告诉它，使用ChatOpenAI LLM使用的计算Token的方法。</p><h2 id=conversationsummarybuffermemory>ConversationSummaryBufferMemory</h2><p>ConversationSummaryBufferMemory试图将消息的显性记忆，保持在我们设定的Token限制值之下，也即</p><ol><li>当Token限制值能覆盖文本长度时，会存储整个对话历史。</li><li>而当Token限制值小于文本长度时，则会为所有历史消息生成摘要，改在记忆中存储历史消息的摘要。</li></ol><p>以情况2为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.memory</span> <span class=kn>import</span> <span class=n>ConversationSummaryBufferMemory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个长字符串</span>
</span></span><span class=line><span class=cl><span class=n>schedule</span> <span class=o>=</span> <span class=s2>&#34;There is a meeting at 8am with your product team. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You will need your powerpoint presentation prepared. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>9am-12pm have time to work on your LangChain </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>project which will go quickly because Langchain is such a powerful tool. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>At Noon, lunch at the italian resturant with a customer who is driving </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>from over an hour away to meet you to understand the latest in AI. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>Be sure to bring your laptop to show the latest LLM demo.&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>ConversationSummaryBufferMemory</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>max_token_limit</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;Hello&#34;</span><span class=p>},</span> <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;What&#39;s up&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;Not much, just hanging&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Cool&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>memory</span><span class=o>.</span><span class=n>save_context</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;What is on the schedule today?&#34;</span><span class=p>},</span> 
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>schedule</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl><span class=n>conversation</span> <span class=o>=</span> <span class=n>ConversationChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>memory</span> <span class=o>=</span> <span class=n>memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conversation</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=s2>&#34;What would be a good demo to show?&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>运行的细节如下：</p><blockquote><p>> Entering new ConversationChain chain&mldr;</p><p>Prompt after formatting:</p><p>The following is a friendly conversation between a human and an AI. The AI is talkative and provides lots of specific details from its context. If the AI does not know the answer to a question, it truthfully says it does not know.</p><p>Current conversation:</p><p>System: The human and AI engage in small talk before discussing the day&rsquo;s schedule. The AI informs the human of a morning meeting with the product team, time to work on the LangChain project, and a lunch meeting with a customer interested in the latest AI developments.</p><p>Human: What would be a good demo to show?</p><p>AI:</p><p>> Finished chain.</p><p>&ldquo;Based on the customer&rsquo;s interest in AI developments, I would suggest showcasing our latest natural language processing capabilities. We could demonstrate how our AI can accurately understand and respond to complex language queries, and even provide personalized recommendations based on the user&rsquo;s preferences. Additionally, we could highlight our AI&rsquo;s ability to learn and adapt over time, making it a valuable tool for businesses looking to improve their customer experience.&rdquo;</p></blockquote><p>可以看到，由于超过了设定的Token限制值，它为历史会话的生成了一个摘要，并放在系统消息的提示词中。</p><h2 id=其他记忆存储管理策略>其他记忆存储管理策略</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.34.37.png width=1184 height=1300 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.34.37_hufe9a9f43432785de90ec5dec88198dea_390623_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.34.37_hufe9a9f43432785de90ec5dec88198dea_390623_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=91 data-flex-basis=218px></p><div class=table-wrapper><table><thead><tr><th>策略</th><th>特点</th></tr></thead><tbody><tr><td>向量数据存储（VectorDataMemory）</td><td>存储嵌入向量，用于检索相关文本块</td></tr><tr><td>实体记忆存储（EntityMemories）</td><td>记住特定实体的详细信息，比如对话中某个重要人物的信息</td></tr></tbody></table></div><p>除了这些记忆存储类型，也可将整个对话存储在传统数据库中，如键值存储（key-value store）或SQL数据库。</p><p>这样就可以回顾整个对话，进行审计或进一步改进系统。</p><h2 id=链>链</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.35.09.png width=1352 height=1308 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.35.09_hu5c90364c4845edbcb1f3a55186e5e104_408777_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.35.09_hu5c90364c4845edbcb1f3a55186e5e104_408777_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=103 data-flex-basis=248px></p><p><strong>链（Chain）是LangChain中最关键的构建模块</strong>。</p><p>除了将 LLM 与提示结合在一起，还可以通过组合多个链，对文本或其他数据执行一系列的操作。</p><p>LangChain提供了多种可用的链类型：</p><div class=table-wrapper><table><thead><tr><th>类型</th><th>场景</th></tr></thead><tbody><tr><td>LLM链（LLMChain）</td><td>将LLM和提示结合在一起</td></tr><tr><td>简单顺序链（SimpleSequentialChain）</td><td>只需要一个输入并且只返回一个输出</td></tr><tr><td>常规顺序链（SequentialChain）</td><td>有多个输入或多个输出</td></tr><tr><td>路由链（RouterChain）</td><td>根据输入的具体内容路由到不同的子链</td></tr></tbody></table></div><p>下面让我们来逐一了解一下。</p><p>首先，用 pandas DataFrame 加载一些稍后要用到的数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=s1>&#39;Data.csv&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.38.36.png width=1220 height=496 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.38.36_huc0757b480bceda5a98dc0adf748b58f6_221984_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.38.36_huc0757b480bceda5a98dc0adf748b58f6_221984_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=245 data-flex-basis=590px></p><h2 id=llm链llmchain>LLM链（LLMChain）</h2><p>LLM链是一个简单但非常强大的链，它是我们后面要讨论的其他链类型的基础，用于将LLM和提示结合在一起。</p><p>例子如下：</p><h4 id=步骤1初始化语言模型和提示>步骤1：初始化语言模型和提示</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chat_models</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains</span> <span class=kn>import</span> <span class=n>LLMChain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用一个比较高的temperature值以获得一些更有意思的结果</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.9</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 接收一个名为“product”的变量，要求LLM生成描述生产该产品的公司的最佳名称</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;What is the best name to describe </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    a company that makes </span><span class=si>{product}</span><span class=s2>?&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2将产品传入链中并运行链>步骤2：将产品传入链中，并运行链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>product</span> <span class=o>=</span> <span class=s2>&#34;Queen Size Sheet Set&#34;</span>
</span></span><span class=line><span class=cl><span class=n>chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>product</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>运行链后，它将在后台格式化提示词，然后将格式化后的完整提示词传递给LLM，然后得到结果：</p><blockquote><p>&lsquo;Royal Beddings.&rsquo;</p></blockquote><h2 id=简单顺序链simplesequentialchain>简单顺序链（SimpleSequentialChain）</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.39.51.png width=1622 height=1020 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.39.51_hu317d630e86a3269847b8ca5af0b56617_365903_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.39.51_hu317d630e86a3269847b8ca5af0b56617_365903_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=159 data-flex-basis=381px></p><p>当我们的子链只需要一个输入并且只返回一个输出时，简单顺序链很有效。</p><p>例子如下：</p><h4 id=步骤1初始化语言模型>步骤1：初始化语言模型</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains</span> <span class=kn>import</span> <span class=n>SimpleSequentialChain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.9</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2创建第一个链>步骤2：创建第一个链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 提示模板1：接受产品并返回描述该公司的最佳名称</span>
</span></span><span class=line><span class=cl><span class=n>first_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;What is the best name to describe </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    a company that makes </span><span class=si>{product}</span><span class=s2>?&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一个链</span>
</span></span><span class=line><span class=cl><span class=n>chain_one</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>first_prompt</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3创建第二个链>步骤3：创建第二个链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 提示模板2：获取公司名称，然后输出该公司的 20 字描述</span>
</span></span><span class=line><span class=cl><span class=n>second_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Write a 20 words description for the following </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    company:</span><span class=si>{company_name}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 第二个链</span>
</span></span><span class=line><span class=cl><span class=n>chain_two</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>second_prompt</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4创建简单顺序链实例并运行链>步骤4：创建简单顺序链实例，并运行链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 第一个链的输出将传递到第二个链</span>
</span></span><span class=line><span class=cl><span class=n>overall_simple_chain</span> <span class=o>=</span> <span class=n>SimpleSequentialChain</span><span class=p>(</span><span class=n>chains</span><span class=o>=</span><span class=p>[</span><span class=n>chain_one</span><span class=p>,</span> <span class=n>chain_two</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                             <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                                            <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>overall_simple_chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>product</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>运行的细节如下：</p><blockquote><p>> Entering new SimpleSequentialChain chain&mldr;</p><p>&ldquo;Royal Bedding Co.&rdquo;</p><p>&ldquo;Royal Bedding Co. offers luxurious and comfortable bedding solutions for a restful and regal sleep experience fit for royalty.&rdquo;</p><p>> Finished chain.</p></blockquote><p>可以看到，它首先输出公司名称，然后将其传递到第二条链，并给出该公司可能的业务描述。</p><h2 id=常规顺序链sequentialchain>常规顺序链（SequentialChain）</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.40.29.png width=1620 height=1202 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.40.29_hu92af770f6d1a9a5d2bb1f2e8d4d2f923_544177_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.40.29_hu92af770f6d1a9a5d2bb1f2e8d4d2f923_544177_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=134 data-flex-basis=323px></p><p>当有多个输入或多个输出时，可以使用常规顺序链。</p><p>例子如下：</p><h4 id=步骤1初始化语言模型-1>步骤1：初始化语言模型</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains</span> <span class=kn>import</span> <span class=n>SequentialChain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.9</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2创建一堆将依次使用的链>步骤2：创建一堆将依次使用的链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 第一条链，将评论翻译成英语。</span>
</span></span><span class=line><span class=cl><span class=n>first_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Translate the following review to english:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;</span><span class=se>\n\n</span><span class=si>{Review}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chain_one</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>first_prompt</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                     <span class=n>output_key</span><span class=o>=</span><span class=s2>&#34;English_Review&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>           
</span></span><span class=line><span class=cl><span class=c1># 第二条链，用一句话总结该评论       </span>
</span></span><span class=line><span class=cl><span class=n>second_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Can you summarize the following review in 1 sentence:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;</span><span class=se>\n\n</span><span class=si>{English_Review}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chain_two</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>second_prompt</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                     <span class=n>output_key</span><span class=o>=</span><span class=s2>&#34;summary&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第三条链，检测原始评论的语言</span>
</span></span><span class=line><span class=cl><span class=n>third_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;What language is the following review:</span><span class=se>\n\n</span><span class=si>{Review}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chain_three</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>third_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>output_key</span><span class=o>=</span><span class=s2>&#34;language&#34;</span>
</span></span><span class=line><span class=cl>                      <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第四条链，接收第二条链的摘要内容(&#34;summary&#34;变量)，以及第三条链的语言类别(&#34;language&#34;变量)，要求后续回复摘要内容时使用指定语言。</span>
</span></span><span class=line><span class=cl><span class=n>fourth_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Write a follow up response to the following &#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;summary in the specified language:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>Summary: </span><span class=si>{summary}</span><span class=se>\n\n</span><span class=s2>Language: </span><span class=si>{language}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chain_four</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>fourth_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>output_key</span><span class=o>=</span><span class=s2>&#34;followup_message&#34;</span>
</span></span><span class=line><span class=cl>                     <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>常规顺序链中的任何一个步骤，都可以接收来自上游的多个输入变量，特别当你有复杂的下游链需要和多个上游链组合时，这会非常有用。</p><h4 id=步骤3将这些链组合在顺序链中并指定输入与输出变量>步骤3：将这些链组合在顺序链中，并指定输入与输出变量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>overall_chain</span> <span class=o>=</span> <span class=n>SequentialChain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chains</span><span class=o>=</span><span class=p>[</span><span class=n>chain_one</span><span class=p>,</span> <span class=n>chain_two</span><span class=p>,</span> <span class=n>chain_three</span><span class=p>,</span> <span class=n>chain_four</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;Review&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>output_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;English_Review&#34;</span><span class=p>,</span> <span class=s2>&#34;summary&#34;</span><span class=p>,</span><span class=s2>&#34;followup_message&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>让这些变量名称准确排列非常重要，因为有很多不同的输入和输出。如果你遇到任何问题，请检查它们排列顺序是否正确。</p><h4 id=步骤4选择一条评论并将其传递到整个链中>步骤4：选择一条评论并将其传递到整个链中</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>review</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>Review</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>overall_chain</span><span class=p>(</span><span class=n>review</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>执行的细节如下：</p><blockquote><p>> Entering new SequentialChain chain&mldr;</p><p>> Finished chain.</p><p>{&lsquo;Review&rsquo;: &ldquo;Je trouve le goût médiocre. La mousse ne tient pas, c&rsquo;est bizarre. J&rsquo;achète les mêmes dans le commerce et le goût est bien meilleur&mldr;\nVieux lot ou contrefaçon !?&rdquo;,</p><p>&lsquo;English_Review&rsquo;: &ldquo;I find the taste mediocre. The foam doesn&rsquo;t hold up, it&rsquo;s weird. I buy the same ones in stores and the taste is much better&mldr; Old batch or counterfeit!?&rdquo;,</p><p>&lsquo;summary&rsquo;: &lsquo;The reviewer expresses dissatisfaction with the taste and foam of the product, suspecting that it might be an old batch or counterfeit.&rsquo;,</p><p>&lsquo;followup_message&rsquo;: &ldquo;Réponse : Le critique exprime sa déception quant au goût et à la mousse du produit, soupçonnant qu&rsquo;il s&rsquo;agit peut-être d&rsquo;un lot périmé ou contrefait. Il est important que les fabricants prennent des mesures pour garantir la qualité de leurs produits afin de maintenir la confiance de leurs clients. Nous espérons que ce problème sera rapidement résolu pour que les consommateurs puissent profiter du produit tel qu&rsquo;il est censé être.&rdquo;}</p></blockquote><p>可以看到，其最终采用了检测到的原始语言——法语对摘要内容进行了回复。</p><h2 id=路由链routerchain>路由链（RouterChain）</h2><p><img src=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.41.15.png width=1638 height=1122 srcset="/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.41.15_hube66deaf251e62546d64cef5593d50ab_472012_480x0_resize_box_3.png 480w, /p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/iShot_2023-08-29_22.41.15_hube66deaf251e62546d64cef5593d50ab_472012_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=145 data-flex-basis=350px></p><p>如果你有多个子链，且每个子链专门负责处理某种特定类型的输入，这种情况就可以使用路由链。</p><p><strong>路由链会根据输入的具体内容路由到不同的子链</strong>。</p><p>它会首先判断该使用哪个子链，然后将输入传递到相应的子链。</p><p>例子如下：</p><h4 id=步骤1提供多个特定类型的提示模板>步骤1：提供多个特定类型的提示模板</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 第一个提示，适合回答物理问题</span>
</span></span><span class=line><span class=cl><span class=n>physics_template</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a very smart physics professor. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You are great at answering questions about physics in a concise</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>and easy to understand manner. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>When you don&#39;t know the answer to a question you admit</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>that you don&#39;t know.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Here is a question:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{input}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二个提示，适合回答数学问题</span>
</span></span><span class=line><span class=cl><span class=n>math_template</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a very good mathematician. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You are great at answering math questions. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You are so good because you are able to break down </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>hard problems into their component parts, 
</span></span></span><span class=line><span class=cl><span class=s2>answer the component parts, and then put them together</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>to answer the broader question.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Here is a question:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{input}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第三个提示，适合回答历史问题</span>
</span></span><span class=line><span class=cl><span class=n>history_template</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a very good historian. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You have an excellent knowledge of and understanding of people,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>events and contexts from a range of historical periods. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You have the ability to think, reflect, debate, discuss and </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>evaluate the past. You have a respect for historical evidence</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>and the ability to make use of it to support your explanations </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>and judgements.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Here is a question:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{input}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第四个提示,适合回答计算机科学问题。</span>
</span></span><span class=line><span class=cl><span class=n>computerscience_template</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34; You are a successful computer scientist.</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You have a passion for creativity, collaboration,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>forward-thinking, confidence, strong problem-solving capabilities,</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>understanding of theories and algorithms, and excellent communication </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>skills. You are great at answering coding questions. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You are so good because you know how to solve a problem by </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>describing the solution in imperative steps </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>that a machine can easily interpret and you know how to </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>choose a solution that has a good balance between </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>time complexity and space complexity. 
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Here is a question:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{input}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2为每个提示模板提供更多相关信息>步骤2：为每个提示模板提供更多相关信息</h4><p>这些信息将传递给路由链，以帮助路由链决定何时使用哪条子链。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>prompt_infos</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;physics&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Good for answering questions about physics&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;prompt_template&#34;</span><span class=p>:</span> <span class=n>physics_template</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;math&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Good for answering math questions&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;prompt_template&#34;</span><span class=p>:</span> <span class=n>math_template</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;History&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Good for answering history questions&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;prompt_template&#34;</span><span class=p>:</span> <span class=n>history_template</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;computer science&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Good for answering computer science questions&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s2>&#34;prompt_template&#34;</span><span class=p>:</span> <span class=n>computerscience_template</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3导入需要的链类型定义使用的语言模型>步骤3：导入需要的链类型，定义使用的语言模型</h4><p>MultiPromptChain是一种特定类型的链，用于在多个不同提示模板之间进行路由。</p><p>LLMRouterChain会借助语言模型的帮助，让语言模型根据上面提供的名称和描述等信息，判断如何路由。</p><p>RouterOutputParser将LLM输出解析成一个字典，根据字典内容确定下游使用哪条链，以及链的输入应该是什么。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains.router</span> <span class=kn>import</span> <span class=n>MultiPromptChain</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains.router.llm_router</span> <span class=kn>import</span> <span class=n>LLMRouterChain</span><span class=p>,</span><span class=n>RouterOutputParser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.prompts</span> <span class=kn>import</span> <span class=n>PromptTemplate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4创建目标链>步骤4：创建目标链</h4><p>路由链会根据输入内容调用这些目标链的其中一个。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>destination_chains</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>p_info</span> <span class=ow>in</span> <span class=n>prompt_infos</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>p_info</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>prompt_template</span> <span class=o>=</span> <span class=n>p_info</span><span class=p>[</span><span class=s2>&#34;prompt_template&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=n>template</span><span class=o>=</span><span class=n>prompt_template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>destination_chains</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>chain</span>  
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>destinations</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;description&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>prompt_infos</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>destinations_str</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>destinations</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤5创建默认链>步骤5：创建默认链</h4><p>默认链是在路由找不到合适的子链调用时，用来备用的一条链路。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>default_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{input}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>default_chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>default_prompt</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤6定义一个路由提示模板>步骤6：定义一个路由提示模板</h4><p>LLM 会根据提示词的内容在不同链之间路由。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>MULTI_PROMPT_ROUTER_TEMPLATE</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;Given a raw text input to a </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>language model select the model prompt best suited for the input. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You will be given the names of the available prompts and a </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>description of what the prompt is best suited for. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>You may also revise the original input if you think that revising</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>it will ultimately lead to a better response from the language model.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&lt;&lt; FORMATTING &gt;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>Return a markdown code snippet with a JSON object formatted to look like:
</span></span></span><span class=line><span class=cl><span class=s2>\```json
</span></span></span><span class=line><span class=cl><span class=s2>{{{{
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;destination&#34;: string \ name of the prompt to use or &#34;DEFAULT&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;next_inputs&#34;: string \ a potentially modified version of the original input
</span></span></span><span class=line><span class=cl><span class=s2>}}}}
</span></span></span><span class=line><span class=cl><span class=s2>\```
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>REMEMBER: &#34;destination&#34; MUST be one of the candidate prompt </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>names specified below OR it can be &#34;DEFAULT&#34; if the input is not</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>well suited for any of the candidate prompts.
</span></span></span><span class=line><span class=cl><span class=s2>REMEMBER: &#34;next_inputs&#34; can just be the original input </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>if you don&#39;t think any modifications are needed.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&lt;&lt; CANDIDATE PROMPTS &gt;&gt;
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{destinations}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&lt;&lt; INPUT &gt;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>{{input}}
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&lt;&lt; OUTPUT (remember to include the ```json)&gt;&gt;&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤7组合语言模型路由提示模板构成路由链>步骤7：组合语言模型、路由提示模板，构成路由链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>router_template</span> <span class=o>=</span> <span class=n>MULTI_PROMPT_ROUTER_TEMPLATE</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>destinations</span><span class=o>=</span><span class=n>destinations_str</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>router_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>template</span><span class=o>=</span><span class=n>router_template</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;input&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>output_parser</span><span class=o>=</span><span class=n>RouterOutputParser</span><span class=p>(),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>router_chain</span> <span class=o>=</span> <span class=n>LLMRouterChain</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span><span class=n>llm</span><span class=p>,</span> <span class=n>router_prompt</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤8组合路由链目标链和默认链创建整条链>步骤8：组合路由链、目标链和默认链，创建整条链</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=n>MultiPromptChain</span><span class=p>(</span><span class=n>router_chain</span><span class=o>=</span><span class=n>router_chain</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>destination_chains</span><span class=o>=</span><span class=n>destination_chains</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>default_chain</span><span class=o>=</span><span class=n>default_chain</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                        <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤9提问不同类型的问题>步骤9：提问不同类型的问题</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 物理问题</span>
</span></span><span class=line><span class=cl><span class=n>chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&#34;What is black body radiation?&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>输出如下：</p><blockquote><p>> Entering new MultiPromptChain chain&mldr;</p><p>physics: {&lsquo;input&rsquo;: &lsquo;What is black body radiation?&rsquo;}</p><p>> Finished chain.</p><p>&ldquo;Black body radiation refers to the electromagnetic radiation emitted by a perfect black body, which is an object that absorbs all radiation that falls on it and emits radiation at all wavelengths. The radiation emitted by a black body depends only on its temperature and follows a specific distribution known as Planck&rsquo;s law. This type of radiation is important in understanding the behavior of stars, as well as in the development of technologies such as incandescent light bulbs and infrared cameras.&rdquo;</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 数学问题
</span></span><span class=line><span class=cl>chain.run(&#34;what is 2 + 2&#34;)
</span></span></code></pre></td></tr></table></div></div><p>输出如下：</p><blockquote><p>> Entering new MultiPromptChain chain&mldr;</p><p>math: {&lsquo;input&rsquo;: &lsquo;what is 2 + 2&rsquo;}</p><p>> Finished chain.</p><p>&lsquo;As an AI language model, I can answer this question easily. The answer to 2 + 2 is 4.&rsquo;</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 生物问题，无匹配，走默认链
</span></span><span class=line><span class=cl>chain.run(&#34;Why does every cell in our body contain DNA?&#34;)
</span></span></code></pre></td></tr></table></div></div><blockquote><p>> Entering new MultiPromptChain chain&mldr;</p><p>None: {&lsquo;input&rsquo;: &lsquo;Why does every cell in our body contain DNA?&rsquo;}</p><p>> Finished chain.</p><p>&lsquo;Every cell in our body contains DNA because DNA carries the genetic information that determines the characteristics and functions of each cell. DNA contains the instructions for the synthesis of proteins, which are essential for the structure and function of cells. Additionally, DNA is responsible for the transmission of genetic information from one generation to the next. Therefore, every cell in our body needs DNA to carry out its specific functions and to maintain the integrity of the organism as a whole.&rsquo;</p></blockquote><h2 id=相关链接>相关链接</h2><ul><li><p>langchain中文社区 <a class=link href=https://www.langchain.cn/ target=_blank rel=noopener>https://www.langchain.cn/</a></p></li><li><p>langchain教程 <a class=link href=https://python.langchain.com/docs/get_started/introduction.html target=_blank rel=noopener>https://python.langchain.com/docs/get_started/introduction.html</a></p></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/langchain/>LangChain</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/iii-%E5%9F%BA%E4%BA%8E%E7%A7%81%E6%9C%89%E6%95%B0%E6%8D%AE%E4%BD%BF%E7%94%A8langchain%E6%9E%84%E5%BB%BA%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA/><div class=article-details><h2 class=article-title>III: 基于私有数据使用LangChain构建聊天机器人</h2></div></a></article><article><a href=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/><div class=article-details><h2 class=article-title>II: 基于LangChain的大语言模型应用开发(下)</h2></div></a></article><article><a href=/p/i-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF%E9%89%B4%E8%B5%8F/><div class=article-details><h2 class=article-title>I: 向量数据库技术鉴赏</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 importzhh的小破站</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>