<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="基于文档的问答 LLM可以根据从PDF文件、网页或公司内部文档中提取的文本来回答问题，这使得LLM能够与未经训练的数据结合起来，从而更灵活地适"><title>II: 基于LangChain的大语言模型应用开发(下)</title><link rel=canonical href=https://blog.importzhh.me/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/><link rel=stylesheet href=/scss/style.min.0d8902b26558cddb5286ea49f2a7aadd5761ed898547e29e5ab572d8c0619ba6.css><meta property="og:title" content="II: 基于LangChain的大语言模型应用开发(下)"><meta property="og:description" content="基于文档的问答 LLM可以根据从PDF文件、网页或公司内部文档中提取的文本来回答问题，这使得LLM能够与未经训练的数据结合起来，从而更灵活地适"><meta property="og:url" content="https://blog.importzhh.me/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/"><meta property="og:site_name" content="importzhh的小破站"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="LangChain"><meta property="article:published_time" content="2023-08-29T20:44:47+08:00"><meta property="article:modified_time" content="2023-08-29T20:44:47+08:00"><meta name=twitter:title content="II: 基于LangChain的大语言模型应用开发(下)"><meta name=twitter:description content="基于文档的问答 LLM可以根据从PDF文件、网页或公司内部文档中提取的文本来回答问题，这使得LLM能够与未经训练的数据结合起来，从而更灵活地适"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huce6e906a97de2553354850eae15a0392_8624_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>importzhh的小破站</a></h1><h2 class=site-description>实事求是 思危思退思变</h2></div></header><ol class=social-menu><li><a href=https://github.com/importzhh target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="-1.65 0 259.3 259.3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"><g><path fill="#9edcf2" d="M200.9 199.8c0 13.9-32.2 25.1-71.9 25.1-39.7.0-71.9-11.3-71.9-25.1.0-13.9 32.2-25.1 71.9-25.1C168.7 174.7 200.9 185.9 200.9 199.8zm0 0"/><g><defs><path id="SVGID_1_" d="M98.1 244.8c1.6 7.5 5.5 11.9 9.4 14.5h41.1c5-3.4 10.1-9.8 10.1-21.8v-31s.6-7.7 7.7-10.2c0 0 4.1-2.9-.3-4.5.0.0-19.5-1.6-19.5 14.4v23.6s.8 8.7-3.8 12.3v-29.2s.3-9.3 5.1-12.8c0 0 3.2-5.7-3.8-4.2.0.0-13.4 1.9-14 17.6l-.3 30h-3.2l-.3-30c-.6-15.6-14-17.6-14-17.6-7-1.6-3.8 4.2-3.8 4.2 4.8 3.5 5.1 12.8 5.1 12.8v29.5c-4.6-3.3-3.8-12.6-3.8-12.6v-23.6c0-16-19.5-14.4-19.5-14.4-4.5 1.6-.3 4.5-.3 4.5 7 2.6 7.7 10.2 7.7 10.2v21.7L98.1 244.8z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" overflow="visible"/></clipPath><path clip-path="url(#SVGID_2_)" fill="#7dbce7" d="M200.9 199.8c0 13.9-32.2 25.1-71.9 25.1-39.7.0-71.9-11.3-71.9-25.1.0-13.9 32.2-25.1 71.9-25.1C168.7 174.7 200.9 185.9 200.9 199.8zm0 0"/></g><path fill="#9edcf2" d="M46.9 125.9l-2.1 7.2s-.5 2.6 1.9 3.1c2.6-.1 2.4-2.5 2.2-3.2L46.9 125.9zm0 0"/><path fill="#010101" d="M255.8 95.6l.2-.9c-21.1-4.2-42.7-4.3-55.8-3.7 2.1-7.7 2.8-16.7 2.8-26.6.0-14.3-5.4-25.7-14-34.3 1.5-4.9 3.5-15.8-2-29.7.0.0-9.8-3.1-32.1 11.8-8.7-2.2-18-3.3-27.3-3.3-10.2.0-20.5 1.3-30.2 3.9C74.4-2.9 64.3.3 64.3.3c-6.6 16.5-2.5 28.8-1.3 31.8-7.8 8.4-12.5 19.1-12.5 32.2.0 9.9 1.1 18.8 3.9 26.5-13.2-.5-34-.3-54.4 3.8l.2.9c20.4-4.1 41.4-4.2 54.5-3.7.6 1.6 1.3 3.2 2 4.7-13 .4-35.1 2.1-56.3 8.1l.3.9c21.4-6 43.7-7.6 56.6-8 7.8 14.4 23 23.8 50.2 26.7-3.9 2.6-7.8 7-9.4 14.5-5.3 2.5-21.9 8.7-31.9-8.5.0.0-5.6-10.2-16.3-11 0 0-10.4-.2-.7 6.5.0.0 6.9 3.3 11.7 15.6.0.0 6.3 21 36.4 14.2V177s-.6 7.7-7.7 10.2c0 0-4.2 2.9.3 4.5.0.0 19.5 1.6 19.5-14.4v-23.6s-.8-9.4 3.8-12.6v38.8s-.3 9.3-5.1 12.8c0 0-3.2 5.7 3.8 4.2.0.0 13.4-1.9 14-17.6l.3-39.3h3.2l.3 39.3c.6 15.6 14 17.6 14 17.6 7 1.6 3.8-4.2 3.8-4.2-4.8-3.5-5.1-12.8-5.1-12.8v-38.5c4.6 3.6 3.8 12.3 3.8 12.3v23.6c0 16 19.5 14.4 19.5 14.4 4.5-1.6.3-4.5.3-4.5-7-2.6-7.7-10.2-7.7-10.2v-31c0-12.1-5.1-18.5-10.1-21.8 29-2.9 42.9-12.2 49.3-26.8 12.7.3 35.6 1.9 57.4 8.1l.3-.9c-21.7-6.1-44.4-7.7-57.3-8.1.6-1.5 1.1-3 1.6-4.6C212.9 91.4 234.6 91.4 255.8 95.6zm0 0"/><path fill="#f5ccb3" d="M174.6 63.7c6.2 5.7 9.9 12.5 9.9 19.8.0 34.4-25.6 35.3-57.2 35.3S70.1 114 70.1 83.5c0-7.3 3.6-14.1 9.8-19.7 10.3-9.4 27.7-4.4 47.4-4.4 19.7.0 37-5.1 47.3 4.3zm0 0"/><path fill="#fff" d="M108.3 85.3c0 9.5-5.3 17.1-11.9 17.1-6.6.0-11.9-7.7-11.9-17.1.0-9.5 5.3-17.1 11.9-17.1C103 68.1 108.3 75.8 108.3 85.3zm0 0"/><path fill="#af5c51" d="M104.5 85.5c0 6.3-3.6 11.4-7.9 11.4-4.4.0-7.9-5.1-7.9-11.4.0-6.3 3.6-11.4 7.9-11.4S104.5 79.2 104.5 85.5zm0 0"/><path fill="#fff" d="M172.2 85.3c0 9.5-5.3 17.1-11.9 17.1s-11.9-7.7-11.9-17.1c0-9.5 5.3-17.1 11.9-17.1C166.8 68.1 172.2 75.8 172.2 85.3zm0 0"/><path fill="#af5c51" d="M168.3 85.5c0 6.3-3.6 11.4-7.9 11.4-4.4.0-7.9-5.1-7.9-11.4.0-6.3 3.6-11.4 7.9-11.4C164.8 74.1 168.3 79.2 168.3 85.5zm0 0"/><path fill="#af5c51" d="M130.5 100.5c0 1.6-1.3 3-3 3-1.6.0-3-1.3-3-3s1.3-3 3-3c1.59999999999999.0 3 1.3 3 3zm0 0"/><path fill="#af5c51" d="M120.6 108c-.2-.5.1-1 .6-1.2s1 .1 1.2.6c.8 2.2 2.8 3.6 5.1 3.6s4.3-1.5 5.1-3.6c.2-.5.7-.8 1.2-.6s.8.7.6 1.2c-1 2.9-3.8 4.9-6.9 4.9C124.4 112.9 121.6 110.9 120.6 108zm0 0"/><path fill="#c4e5d9" d="M54.5 121.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4.0-.8.9-1.4 2.1-1.4C53.6 120.2 54.5 120.8 54.5 121.6zm0 0"/><path fill="#c4e5d9" d="M60.3 124.8c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4.0-.8.9-1.4 2.1-1.4C59.4 123.4 60.3 124 60.3 124.8zm0 0"/><path fill="#c4e5d9" d="M63.8 129c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C62.9 127.5 63.8 128.2 63.8 129zm0 0"/><path fill="#c4e5d9" d="M67 133.8c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C66.1 132.3 67 133 67 133.8zm0 0"/><path fill="#c4e5d9" d="M70.5 138.2c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C69.6 136.8 70.5 137.4 70.5 138.2zm0 0"/><path fill="#c4e5d9" d="M75.3 142.1c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C74.4 140.6 75.3 141.3 75.3 142.1zm0 0"/><path fill="#c4e5d9" d="M82 144.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4S82 143.8 82 144.6zm0 0"/><path fill="#c4e5d9" d="M88.7 144.6c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4S88.7 143.8 88.7 144.6zm0 0"/><path fill="#c4e5d9" d="M95.5 143.5c0 .8-.9 1.4-2.1 1.4-1.1.0-2.1-.6-2.1-1.4s.9-1.4 2.1-1.4C94.5 142.1 95.5 142.7 95.5 143.5zm0 0"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#基于文档的问答>基于文档的问答</a></li><li><a href=#简单实现以轻松完成文档问答功能>简单实现，以轻松完成文档问答功能</a><ol><li><ol><li><a href=#步骤1初始化csv加载器为其指定一个csv文件的路径>步骤1：初始化CSV加载器，为其指定一个CSV文件的路径</a></li><li><a href=#步骤2创建一个内存方式的向量存储传入上一步创建的加载器>步骤2：创建一个内存方式的向量存储，传入上一步创建的️️加载器。</a></li><li><a href=#步骤3定义查询内容并使用indexquery生成响应>步骤3：定义查询内容，并使用index.query生成响应</a></li><li><a href=#步骤4展示查询结果的表格以及摘要>步骤4：展示查询结果的表格以及摘要</a></li></ol></li></ol></li><li><a href=#文档问答功能的底层原理>文档问答功能的底层原理</a><ol><li><a href=#嵌入embedding>嵌入（Embedding）</a></li><li><a href=#向量数据库vector-database>向量数据库（Vector Database）</a></li></ol></li><li><a href=#详细实现以查看每一步的执行过程>详细实现，以查看每一步的执行过程</a><ol><li><ol><li><a href=#步骤1初始化csv加载器为其指定一个csv文件的路径-1>步骤1：初始化CSV加载器，为其指定一个CSV文件的路径</a></li><li><a href=#步骤2为加载的所有文本片段生成嵌入并存储在一个向量存储器中>步骤2：为加载的所有文本片段生成嵌入，并存储在一个向量存储器中</a></li><li><a href=#步骤3使用retrievalqa链对查询进行检索然后在检索的文档上进行问答>步骤3：使用RetrievalQA链对查询进行检索，然后在检索的文档上进行问答</a></li><li><a href=#步骤4创建一个查询并把查询的内容传入链并运行>步骤4：创建一个查询，并把查询的内容传入链并运行</a></li><li><a href=#步骤5展示查询结果的表格以及摘要>步骤5：展示查询结果的表格以及摘要</a></li></ol></li></ol></li><li><a href=#可选的链类型chain_type>可选的链类型(chain_type)</a><ol><li><a href=#stuff>stuff</a></li><li><a href=#map_reduce>Map_reduce</a></li><li><a href=#refine>Refine</a></li><li><a href=#map_rerank>Map_rerank</a></li></ol></li><li><a href=#评估>评估</a><ol><li><ol><li><a href=#步骤1使用语言模型自动生成评估数据集>步骤1：使用语言模型自动生成评估数据集</a></li><li><a href=#步骤2将生成的问答对添加到已有的评估数据集中>步骤2：将生成的问答对添加到已有的评估数据集中</a></li><li><a href=#步骤3为所有不同的示例生成实际答案>步骤3：为所有不同的示例生成实际答案</a></li><li><a href=#步骤4对llm应用的输出进行评估>步骤4：对LLM应用的输出进行评估</a></li><li><a href=#步骤5打印问题标准答案实际答案和评分>步骤5：打印问题、标准答案、实际答案和评分</a></li></ol></li></ol></li><li><a href=#使用langchain评估平台>使用LangChain评估平台</a><ol><li><a href=#查看和跟踪评估过程中的输入和输出>查看和跟踪评估过程中的输入和输出</a></li><li><a href=#可视化链中每个步骤输出的信息>可视化链中每个步骤输出的信息</a></li><li><a href=#将示例添加到数据集中以便持久化和进一步评估>将示例添加到数据集中，以便持久化和进一步评估</a></li></ol></li><li><a href=#代理>代理</a></li><li><a href=#使用内置于-langchain-的工具>使用内置于 LangChain 的工具</a><ol><li><ol><li><a href=#步骤1初始化语言模型>步骤1：初始化语言模型</a></li><li><a href=#步骤2加载工具>步骤2：加载工具</a></li><li><a href=#步骤3初始化代理>步骤3：初始化代理</a></li><li><a href=#步骤4向代理提问>步骤4：向代理提问</a></li></ol></li></ol></li><li><a href=#使用-python-代理工具>使用 Python 代理工具</a><ol><li><ol><li><a href=#步骤1创建python代理>步骤1：创建Python代理</a></li><li><a href=#步骤2要求代理编写排序代码并打印输出结果>步骤2：要求代理编写排序代码，并打印输出结果</a></li></ol></li></ol></li><li><a href=#使用自定义的工具>使用自定义的工具</a><ol><li><ol><li><a href=#步骤1定义一个工具用于获取当前日期>步骤1：定义一个工具，用于获取当前日期</a></li><li><a href=#步骤2初始化代理将自定义工具加到现有工具列表里>步骤2：初始化代理，将自定义工具加到现有工具列表里</a></li><li><a href=#步骤3调用代理获取当前日期>步骤3：调用代理，获取当前日期</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/chatgpt/>chatgpt</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/>II: 基于LangChain的大语言模型应用开发(下)</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Aug 29, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 9 分钟</time></div></footer></div></header><section class=article-content><h2 id=基于文档的问答>基于文档的问答</h2><p>LLM可以根据从PDF文件、网页或公司内部文档中提取的文本来回答问题，这使得LLM能够与未经训练的数据结合起来，从而更灵活地适配不同应用场景。</p><p>要构建一个基于文档的问答系统，需要引入 LangChain 的更多关键组件，例如嵌入（Embedding）模型和向量存储（Vector Stores）。</p><h2 id=简单实现以轻松完成文档问答功能>简单实现，以轻松完成文档问答功能</h2><p>首先，需要导入一些辅助构建链的工具：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chains</span> <span class=kn>import</span> <span class=n>RetrievalQA</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chat_models</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.document_loaders</span> <span class=kn>import</span> <span class=n>CSVLoader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.vectorstores</span> <span class=kn>import</span> <span class=n>DocArrayInMemorySearch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>IPython.display</span> <span class=kn>import</span> <span class=n>display</span><span class=p>,</span> <span class=n>Markdown</span>
</span></span></code></pre></td></tr></table></div></div><div class=table-wrapper><table><thead><tr><th>工具</th><th>用途</th></tr></thead><tbody><tr><td>RetrievalQA</td><td>检索文档</td></tr><tr><td>CSVLoader</td><td>加载专用数据(如CSV)，用来与模型结合使用</td></tr><tr><td>DocArrayInMemorySearch</td><td>内存方式的向量存储，不需要连接到任何类型的外部数据库</td></tr></tbody></table></div><h4 id=步骤1初始化csv加载器为其指定一个csv文件的路径>步骤1：初始化CSV加载器，为其指定一个CSV文件的路径</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>file</span> <span class=o>=</span> <span class=s1>&#39;OutdoorClothingCatalog_1000.csv&#39;</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>CSVLoader</span><span class=p>(</span><span class=n>file_path</span><span class=o>=</span><span class=n>file</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2创建一个内存方式的向量存储传入上一步创建的加载器>步骤2：创建一个内存方式的向量存储，传入上一步创建的️️加载器。</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.indexes</span> <span class=kn>import</span> <span class=n>VectorstoreIndexCreator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorstoreIndexCreator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>vectorstore_cls</span><span class=o>=</span><span class=n>DocArrayInMemorySearch</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>from_loaders</span><span class=p>([</span><span class=n>loader</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3定义查询内容并使用indexquery生成响应>步骤3：定义查询内容，并使用index.query生成响应</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span><span class=s2>&#34;Please list all your shirts with sun protection </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>in a table in markdown and summarize each one.&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4展示查询结果的表格以及摘要>步骤4：展示查询结果的表格以及摘要</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=n>response</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.50.01.png width=1342 height=1116 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.50.01_hu29c8a7c65b584f8a0b03a3615b66fdee_958611_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.50.01_hu29c8a7c65b584f8a0b03a3615b66fdee_958611_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=120 data-flex-basis=288px></p><h2 id=文档问答功能的底层原理>文档问答功能的底层原理</h2><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.50.45.png width=774 height=546 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.50.45_hudb89487790875d63c69e2600b9a5702b_149374_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.50.45_hudb89487790875d63c69e2600b9a5702b_149374_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=141 data-flex-basis=340px></p><p>要想让语言模型与大量文档相结合，有一个关键问题必须解决。</p><p>那就是，语言模型每次只能处理几千个单词，如何才能让它对一个大型文档的全部内容进行问答呢？</p><p>这里就要用到嵌入（Embedding）和向量存储（Vector Stores）这两个技术。</p><h3 id=嵌入embedding>嵌入（Embedding）</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.51.16.png width=1474 height=1400 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.51.16_hu8d0111ac0114b0151448d977bb16555f_530786_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.51.16_hu8d0111ac0114b0151448d977bb16555f_530786_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=105 data-flex-basis=252px></p><p><strong>嵌入是一种将文本片段转换为数字表示的方法，这些数字能够反映文本的语义信息</strong>。</p><p>语义相近的文本会有相近的向量，这样我们就可以在向量空间中对文本进行比较。</p><p>比如，</p><ul><li>两个同样描述宠物的句子的向量，其相似度会非常高。</li><li>而与一个描述汽车的句子的向量相比较，其相似度则会很低。</li></ul><p><strong>通过向量相似度，我们可以轻松地找出文本片段之间的语义关系</strong>。</p><p>利用这个特性，我们可以从文档中检索出与问题语义最匹配的文本片段，然后将它们和问题一起交给语言模型来生成答案。</p><h3 id=向量数据库vector-database>向量数据库（Vector Database）</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.51.50.png width=1410 height=1516 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.51.50_hu3570e8c92a9c96230649d6f1466e03ff_392935_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.51.50_hu3570e8c92a9c96230649d6f1466e03ff_392935_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=93 data-flex-basis=223px></p><p><strong>向量数据库是用于保存嵌入向量表示的数据库</strong>。</p><p>我们可以将大型文档拆分成较小的块，为每个块生成一个嵌入，并将其和原始块一起存储到数据库中。</p><p>这就是我们创建索引的过程。</p><p>索引创建好后，我们就可以用它来查询与问题最相关的文本片段：</p><ol><li>当一个问题进来后，为问题生成嵌入；</li><li>将其与向量存储中的所有向量进行比较，选择最相似的n个文本片段；</li><li>将这些文本片段和问题一起传递给语言模型；</li><li>让语言模型根据检索到的文档内容生成最佳答案。</li></ol><h2 id=详细实现以查看每一步的执行过程>详细实现，以查看每一步的执行过程</h2><h4 id=步骤1初始化csv加载器为其指定一个csv文件的路径-1>步骤1：初始化CSV加载器，为其指定一个CSV文件的路径</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>CSVLoader</span><span class=p>(</span><span class=n>file_path</span><span class=o>=</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>docs</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2为加载的所有文本片段生成嵌入并存储在一个向量存储器中>步骤2：为加载的所有文本片段生成嵌入，并存储在一个向量存储器中</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.embeddings</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>DocArrayInMemorySearch</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>docs</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>embeddings</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以用一段特定文本来查看生成的嵌入内容形式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>embed</span> <span class=o>=</span> <span class=n>embeddings</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=s2>&#34;Hi my name is Harrison&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印嵌入的维度</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>embed</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 1536</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印前5个数字</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>embed</span><span class=p>[:</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># [-0.021930990740656853, 0.006712669972330332, -0.018181458115577698, -0.039156194776296616, -0.014079621061682701]</span>
</span></span></code></pre></td></tr></table></div></div><p>从打印结果可知，这个嵌入是一个1536维的向量，以及向量中的数字是如何表示的。</p><p>我们也可以直接输入一段查询内容，查看通过向量存储器检索到的与查询内容相似的文本片段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;Please suggest a shirt with sunblocking&#34;</span>
</span></span><span class=line><span class=cl><span class=n>docs</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印检索到的文本片段数</span>
</span></span><span class=line><span class=cl><span class=nb>len</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印第一个文本片段内容</span>
</span></span><span class=line><span class=cl><span class=n>docs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># Document(page_content=&#39;: 255\nname: Sun Shield Shirt by\ndescription: &#34;Block the sun, not the fun – our high-performance sun shirt is guaranteed to protect from harmful UV rays. \n\nSize &amp; Fit: Slightly Fitted: Softly shapes the body. Falls at hip.\n\nFabric &amp; Care: 78% nylon, 22% Lycra Xtra Life fiber. UPF 50+ rated – the highest rated sun protection possible. Handwash, line dry.\n\nAdditional Features: Wicks moisture for quick-drying comfort. Fits comfortably over your favorite swimsuit. Abrasion resistant for season after season of wear. Imported.\n\nSun Protection That Won\&#39;t Wear Off\nOur high-performance fabric provides SPF 50+ sun protection, blocking 98% of the sun\&#39;s harmful rays. This fabric is recommended by The Skin Cancer Foundation as an effective UV protectant.&#39;, metadata={&#39;source&#39;: &#39;OutdoorClothingCatalog_1000.csv&#39;, &#39;row&#39;: 255})</span>
</span></span></code></pre></td></tr></table></div></div><p>从打印结果可知，检索到了4个相似的文本片段，而返回的第一个文本片段也确实与查询内容相关。</p><h4 id=步骤3使用retrievalqa链对查询进行检索然后在检索的文档上进行问答>步骤3：使用RetrievalQA链对查询进行检索，然后在检索的文档上进行问答</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stuff表示将文本片段合并成一段文本</span>
</span></span><span class=line><span class=cl><span class=n>qa_stuff</span> <span class=o>=</span> <span class=n>RetrievalQA</span><span class=o>.</span><span class=n>from_chain_type</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>chain_type</span><span class=o>=</span><span class=s2>&#34;stuff&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>retriever</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>RetrievalQA链其实就是把合并文本片段和调用语言模型这两步骤封装起来，如果没有RetrievalQA链，我们需要这样子实现：</p><p>1.将检索出来的文本片段合并成一段文本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>qdocs</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>docs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>docs</span><span class=p>))])</span>
</span></span></code></pre></td></tr></table></div></div><p>2.将合并后的文本和问题一起传给LLM</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>call_as_llm</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>qdocs</span><span class=si>}</span><span class=s2> Question: Please list all your </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>shirts with sun protection in a table in markdown and summarize each one.&#34;</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4创建一个查询并把查询的内容传入链并运行>步骤4：创建一个查询，并把查询的内容传入链并运行</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>qa_stuff</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤5展示查询结果的表格以及摘要>步骤5：展示查询结果的表格以及摘要</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=n>response</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.52.33.png width=1288 height=1094 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.52.33_hu313cb386c2f281b80b128aaf28b23a33_739477_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.52.33_hu313cb386c2f281b80b128aaf28b23a33_739477_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=117 data-flex-basis=282px></p><h2 id=可选的链类型chain_type>可选的链类型(chain_type)</h2><h3 id=stuff>stuff</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.53.00.png width=1232 height=1314 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.53.00_hu0c83dcd4d17b41f526f1b25b38335ad0_378942_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.53.00_hu0c83dcd4d17b41f526f1b25b38335ad0_378942_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=93 data-flex-basis=225px></p><p>将所有内容放入一个提示中，发送给语言模型并获取一个回答。这种方法简单、廉价且效果不错。</p><p>当文档数量较少且文档长度较短的情况下，这种方法是可行的。</p><h3 id=map_reduce>Map_reduce</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.54.08.png width=1390 height=506 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.54.08_hu409fb63c939e05aee1d90892872ed7bb_155433_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.54.08_hu409fb63c939e05aee1d90892872ed7bb_155433_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=274 data-flex-basis=659px></p><p>将每个内容和问题一起传递给语言模型，并将所有单独的回答汇总成最终答案。</p><p>这种方法可以处理任意数量的文档，并且可以并行处理各个问题。</p><h3 id=refine>Refine</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.54.40.png width=1454 height=480 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.54.40_hud90492e942c79558f402d71d02a6f065_140778_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.54.40_hud90492e942c79558f402d71d02a6f065_140778_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=302 data-flex-basis=727px></p><p>迭代地处理多个文档，它会基于前一个文档的答案来构建答案。</p><p>这种方法适合组合信息和逐步构建答案，但速度较慢。</p><h3 id=map_rerank>Map_rerank</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.55.11.png width=1322 height=452 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.55.11_hua566e63033a590b549b9e3695a20003f_156896_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_22.55.11_hua566e63033a590b549b9e3695a20003f_156896_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=292 data-flex-basis=701px></p><p>每个文档进行单独的语言模型调用，并要求返回一个分数，然后选择最高分数的答案。</p><p>这种方法需要告诉语言模型如何评分，并且需要针对这部分指令进行优化。</p><h2 id=评估>评估</h2><p>评估有两个目的：</p><ul><li>检验LLM应用是否达到了验收标准</li><li>分析改动对于LLM应用性能的影响</li></ul><p>基本的思路就是利用语言模型本身和链本身，来辅助评估其他的语言模型、链和应用程序。</p><p>我们还是以上一节课的文档问答应用为例。</p><p>评估过程需要用到评估数据集，我们可以直接硬编码一些示例数据集，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>examples</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;Do the Cozy Comfort Pullover Set</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>        have side pockets?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;Yes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;What collection is the Ultra-Lofty </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>        850 Stretch Down Hooded Jacket from?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;The DownTek collection&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>但这种方式不太方便扩展，也比较耗时，所以，我们可以——</p><h4 id=步骤1使用语言模型自动生成评估数据集>步骤1：使用语言模型自动生成评估数据集</h4><p>QAGenerateChain链用于接收文档，并借助语言模型为每个文档生成一个问答对。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.evaluation.qa</span> <span class=kn>import</span> <span class=n>QAGenerateChain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>example_gen_chain</span> <span class=o>=</span> <span class=n>QAGenerateChain</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span><span class=n>ChatOpenAI</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>new_examples</span> <span class=o>=</span> <span class=n>example_gen_chain</span><span class=o>.</span><span class=n>apply_and_parse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[{</span><span class=s2>&#34;doc&#34;</span><span class=p>:</span> <span class=n>t</span><span class=p>}</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[:</span><span class=mi>5</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以打印看下其返回的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>new_examples</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;query&#39;</span><span class=p>:</span> <span class=s2>&#34;What is the weight of each pair of Women&#39;s Campside Oxfords?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;answer&#39;</span><span class=p>:</span> <span class=s2>&#34;The approximate weight of each pair of Women&#39;s Campside Oxfords is 1 lb. 1 oz.&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2将生成的问答对添加到已有的评估数据集中>步骤2：将生成的问答对添加到已有的评估数据集中</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>examples</span> <span class=o>+=</span> <span class=n>new_examples</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3为所有不同的示例生成实际答案>步骤3：为所有不同的示例生成实际答案</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 这里的qa对应的是上一节课的RetrievalQA链</span>
</span></span><span class=line><span class=cl><span class=n>predictions</span> <span class=o>=</span> <span class=n>qa</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>examples</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤4对llm应用的输出进行评估>步骤4：对LLM应用的输出进行评估</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.evaluation.qa</span> <span class=kn>import</span> <span class=n>QAEvalChain</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>eval_chain</span> <span class=o>=</span> <span class=n>QAEvalChain</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span><span class=n>llm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 传入示例列表和实际答案列表</span>
</span></span><span class=line><span class=cl><span class=n>graded_outputs</span> <span class=o>=</span> <span class=n>eval_chain</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=n>examples</span><span class=p>,</span> <span class=n>predictions</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤5打印问题标准答案实际答案和评分>步骤5：打印问题、标准答案、实际答案和评分</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>eg</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Example </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Question: &#34;</span> <span class=o>+</span> <span class=n>predictions</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;query&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Real Answer: &#34;</span> <span class=o>+</span> <span class=n>predictions</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;answer&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Predicted Answer: &#34;</span> <span class=o>+</span> <span class=n>predictions</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;result&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Predicted Grade: &#34;</span> <span class=o>+</span> <span class=n>graded_outputs</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;text&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>列举其中的前3个评估结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Example</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>Question</span><span class=p>:</span> <span class=n>Do</span> <span class=n>the</span> <span class=n>Cozy</span> <span class=n>Comfort</span> <span class=n>Pullover</span> <span class=n>Set</span> <span class=n>have</span> <span class=n>side</span> <span class=n>pockets</span><span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>Real</span> <span class=n>Answer</span><span class=p>:</span> <span class=n>Yes</span>
</span></span><span class=line><span class=cl><span class=n>Predicted</span> <span class=n>Answer</span><span class=p>:</span> <span class=n>The</span> <span class=n>Cozy</span> <span class=n>Comfort</span> <span class=n>Pullover</span> <span class=n>Set</span><span class=p>,</span> <span class=n>Stripe</span> <span class=n>does</span> <span class=n>have</span> <span class=n>side</span> <span class=n>pockets</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Predicted</span> <span class=n>Grade</span><span class=p>:</span> <span class=n>CORRECT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Example</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>Question</span><span class=p>:</span> <span class=n>What</span> <span class=n>collection</span> <span class=ow>is</span> <span class=n>the</span> <span class=n>Ultra</span><span class=o>-</span><span class=n>Lofty</span> <span class=mi>850</span> <span class=n>Stretch</span> <span class=n>Down</span> <span class=n>Hooded</span> <span class=n>Jacket</span> <span class=n>from</span><span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>Real</span> <span class=n>Answer</span><span class=p>:</span> <span class=n>The</span> <span class=n>DownTek</span> <span class=n>collection</span>
</span></span><span class=line><span class=cl><span class=n>Predicted</span> <span class=n>Answer</span><span class=p>:</span> <span class=n>The</span> <span class=n>Ultra</span><span class=o>-</span><span class=n>Lofty</span> <span class=mi>850</span> <span class=n>Stretch</span> <span class=n>Down</span> <span class=n>Hooded</span> <span class=n>Jacket</span> <span class=ow>is</span> <span class=kn>from</span> <span class=nn>the</span> <span class=n>DownTek</span> <span class=n>collection</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Predicted</span> <span class=n>Grade</span><span class=p>:</span> <span class=n>CORRECT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Example</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>Question</span><span class=p>:</span> <span class=n>What</span> <span class=ow>is</span> <span class=n>the</span> <span class=n>weight</span> <span class=n>of</span> <span class=n>each</span> <span class=n>pair</span> <span class=n>of</span> <span class=n>Women</span><span class=s1>&#39;s Campside Oxfords?</span>
</span></span><span class=line><span class=cl><span class=n>Real</span> <span class=n>Answer</span><span class=p>:</span> <span class=n>The</span> <span class=n>approximate</span> <span class=n>weight</span> <span class=n>of</span> <span class=n>each</span> <span class=n>pair</span> <span class=n>of</span> <span class=n>Women</span><span class=s1>&#39;s Campside Oxfords is 1 lb. 1 oz.</span>
</span></span><span class=line><span class=cl><span class=n>Predicted</span> <span class=n>Answer</span><span class=p>:</span> <span class=n>The</span> <span class=n>weight</span> <span class=n>of</span> <span class=n>each</span> <span class=n>pair</span> <span class=n>of</span> <span class=n>Women</span><span class=s1>&#39;s Campside Oxfords is approximately 1 lb. 1 oz.</span>
</span></span><span class=line><span class=cl><span class=n>Predicted</span> <span class=n>Grade</span><span class=p>:</span> <span class=n>CORRECT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>对比第一个评估结果的两个答案可以看到，其标准答案较为简洁，而实际答案则较为详细，但表达的意思都是正确的，语言模型也能识别，因此才把它标记为正确的。</p><p>虽然这两个字符串完全不同，以致于使用传统的正则表达式等手段是无法对它们进行比较的。</p><p>这里就体现了<strong>使用语言模型进行评估的优势——同一个问题的答案可能有很多不同的变体，只要意思相通，就应该被认为是相似的</strong>。</p><h2 id=使用langchain评估平台>使用LangChain评估平台</h2><p>以上操作都可以在LangChain评估平台上以可视化UI界面的形式展示，并对数据进行持久化，包括：</p><h3 id=查看和跟踪评估过程中的输入和输出>查看和跟踪评估过程中的输入和输出</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.00.06.png width=1680 height=1252 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.00.06_hube1ae2b085d02bb096b3069c03c9e287_628754_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.00.06_hube1ae2b085d02bb096b3069c03c9e287_628754_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=134 data-flex-basis=322px></p><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.01.51.png width=1664 height=1818 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.01.51_hu82a1f21550968a2d8b794ad83e9a410e_1001427_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.01.51_hu82a1f21550968a2d8b794ad83e9a410e_1001427_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=91 data-flex-basis=219px></p><h3 id=可视化链中每个步骤输出的信息>可视化链中每个步骤输出的信息</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.03.23.png width=1670 height=1810 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.03.23_hu283bd0b90aa3ebc38ad187ff9d39d375_1440425_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.03.23_hu283bd0b90aa3ebc38ad187ff9d39d375_1440425_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=92 data-flex-basis=221px>
<img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.04.26.png width=1672 height=1788 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.04.26_huf1cf9a5e04b074ecafb96bf18f70b375_1300196_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.04.26_huf1cf9a5e04b074ecafb96bf18f70b375_1300196_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=93 data-flex-basis=224px></p><h3 id=将示例添加到数据集中以便持久化和进一步评估>将示例添加到数据集中，以便持久化和进一步评估</h3><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.05.26.png width=1668 height=1800 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.05.26_hu403007598345804e8c9d520de5e4b53f_915246_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.05.26_hu403007598345804e8c9d520de5e4b53f_915246_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=92 data-flex-basis=222px>
<img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.06.08.png width=1670 height=1764 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.06.08_hu02363e753ad2b691c1023bcd4e446b95_748205_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.06.08_hu02363e753ad2b691c1023bcd4e446b95_748205_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=94 data-flex-basis=227px>
<img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/img.png width=306 height=301 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/img_hu2351c03c864db677349ccb167f98521b_33116_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/img_hu2351c03c864db677349ccb167f98521b_33116_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=101 data-flex-basis=243px></p><h2 id=代理>代理</h2><p>大型语言模型可以作为一个推理引擎，只要给它提供文本或其他信息源，它就会利用互联网上学习到的背景知识或你提供的新信息，来回答问题、推理内容或决定下一步的操作。</p><p>这就是LangChain的代理框架能够帮我们实现的事情，而代理也正是LangChain最强大的功能之一。</p><h2 id=使用内置于-langchain-的工具>使用内置于 LangChain 的工具</h2><h4 id=步骤1初始化语言模型>步骤1：初始化语言模型</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.agent_toolkits</span> <span class=kn>import</span> <span class=n>create_python_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>load_tools</span><span class=p>,</span> <span class=n>initialize_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>AgentType</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.tools.python.tool</span> <span class=kn>import</span> <span class=n>PythonREPLTool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.python</span> <span class=kn>import</span> <span class=n>PythonREPL</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.chat_models</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>temperature参数</li></ul><p>语言模型作为代理的推理引擎，会连接到其他数据和计算资源，我们会希望这个推理引擎尽可能地好用且精确，因此需要把temperature参数设为0。</p><h4 id=步骤2加载工具>步骤2：加载工具</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># llm-math：解决数学问题</span>
</span></span><span class=line><span class=cl><span class=c1># wikipedia：查询维基百科</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=n>load_tools</span><span class=p>([</span><span class=s2>&#34;llm-math&#34;</span><span class=p>,</span><span class=s2>&#34;wikipedia&#34;</span><span class=p>],</span> <span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3初始化代理>步骤3：初始化代理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>agent</span><span class=o>=</span> <span class=n>initialize_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>agent</span><span class=o>=</span><span class=n>AgentType</span><span class=o>.</span><span class=n>CHAT_ZERO_SHOT_REACT_DESCRIPTION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>handle_parsing_errors</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>agent参数</li></ul><p>agent参数 CHAT_ZERO_SHOT_REACT_DESCRIPTION中的CHAT部分，表示这是一个专门为Chat模型优化的代理。REACT部分表示一种组织Prompt的技术，能够最大化语言模型的推理能力。</p><ul><li>handle_parsing_errors</li></ul><p>true表示当内容无法被正常解析时，会将错误内容传回语言模型，让它自行纠正。</p><h4 id=步骤4向代理提问>步骤4：向代理提问</h4><p>数学问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>agent(&#34;What is the 25% of 300?&#34;)
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.09.43.png width=1114 height=1046 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.09.43_hu11d24ff19ee983c4293059b73837ec52_160280_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.09.43_hu11d24ff19ee983c4293059b73837ec52_160280_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=106 data-flex-basis=255px></p><p>百科问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>question</span> <span class=o>=</span> <span class=s2>&#34;Tom M. Mitchell is an American computer scientist </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>and the Founders University Professor at Carnegie Mellon University (CMU)</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>what book did he write?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=p>(</span><span class=n>question</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.11.02.png width=2046 height=1134 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.11.02_hu98281d92d009d26d7d67bdd75017b903_441907_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.11.02_hu98281d92d009d26d7d67bdd75017b903_441907_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=180 data-flex-basis=433px></p><p>从打印出来的中间步骤详细记录中，我们可以看到几个关键词，其表示的含义分别是：</p><div class=table-wrapper><table><thead><tr><th>关键词</th><th>表示含义</th></tr></thead><tbody><tr><td>Thought</td><td>LLM在思考的内容</td></tr><tr><td>Action</td><td>执行特定的动作</td></tr><tr><td>Observation</td><td>从这个动作中观察到了什么</td></tr></tbody></table></div><h2 id=使用-python-代理工具>使用 Python 代理工具</h2><p>类似于ChatGPT的代码解释器，Python 代理工具可以让语言模型编写并执行Python代码，然后将执行的结果返回给代理，让它决定下一步的操作。</p><p>我们的任务目标是对一组客户名单按照姓氏和名字进行排序。</p><h4 id=步骤1创建python代理>步骤1：创建Python代理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_python_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tool</span><span class=o>=</span><span class=n>PythonREPLTool</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤2要求代理编写排序代码并打印输出结果>步骤2：要求代理编写排序代码，并打印输出结果</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>customer_list</span> <span class=o>=</span> <span class=p>[[</span><span class=s2>&#34;Harrison&#34;</span><span class=p>,</span> <span class=s2>&#34;Chase&#34;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                 <span class=p>[</span><span class=s2>&#34;Lang&#34;</span><span class=p>,</span> <span class=s2>&#34;Chain&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                 <span class=p>[</span><span class=s2>&#34;Dolly&#34;</span><span class=p>,</span> <span class=s2>&#34;Too&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                 <span class=p>[</span><span class=s2>&#34;Elle&#34;</span><span class=p>,</span> <span class=s2>&#34;Elem&#34;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                 <span class=p>[</span><span class=s2>&#34;Geoff&#34;</span><span class=p>,</span><span class=s2>&#34;Fusion&#34;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                 <span class=p>[</span><span class=s2>&#34;Trance&#34;</span><span class=p>,</span><span class=s2>&#34;Former&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                 <span class=p>[</span><span class=s2>&#34;Jen&#34;</span><span class=p>,</span><span class=s2>&#34;Ayai&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl><span class=n>agent</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;&#34;&#34;Sort these customers by </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>last name and then first name </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>and print the output: </span><span class=si>{</span><span class=n>customer_list</span><span class=si>}</span><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.11.54.png width=1980 height=866 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.11.54_hu13451fbb01060b4d672c89289e56d678_269800_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.11.54_hu13451fbb01060b4d672c89289e56d678_269800_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=228 data-flex-basis=548px></p><h2 id=使用自定义的工具>使用自定义的工具</h2><p>代理的一个优势就是你可以将其连接到你自己的信息来源、API、数据。</p><h4 id=步骤1定义一个工具用于获取当前日期>步骤1：定义一个工具，用于获取当前日期</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Returns todays date, use this for any </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    questions related to knowing todays date. </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    The input should always be an empty string, </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    and this function will always return todays </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    date - any date mathmatics should occur </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    outside this function.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>除了函数名称，这里还写了一份详细的注释说明，<strong>代理会根据注释中的信息来判断何时应该调用、以及应该如何调用这个工具</strong>。</p><h4 id=步骤2初始化代理将自定义工具加到现有工具列表里>步骤2：初始化代理，将自定义工具加到现有工具列表里</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>agent</span><span class=o>=</span> <span class=n>initialize_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span> <span class=o>+</span> <span class=p>[</span><span class=n>time</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>agent</span><span class=o>=</span><span class=n>AgentType</span><span class=o>.</span><span class=n>CHAT_ZERO_SHOT_REACT_DESCRIPTION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>handle_parsing_errors</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤3调用代理获取当前日期>步骤3：调用代理，获取当前日期</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=p>(</span><span class=s2>&#34;whats the date today?&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>except</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;exception on external access&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.13.04.png width=1478 height=998 srcset="/p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.13.04_huc87c20844b66c57df484d5c4f1680d1d_174376_480x0_resize_box_3.png 480w, /p/ii-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8B/iShot_2023-08-29_23.13.04_huc87c20844b66c57df484d5c4f1680d1d_174376_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=148 data-flex-basis=355px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/langchain/>LangChain</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/iii-%E5%9F%BA%E4%BA%8E%E7%A7%81%E6%9C%89%E6%95%B0%E6%8D%AE%E4%BD%BF%E7%94%A8langchain%E6%9E%84%E5%BB%BA%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA/><div class=article-details><h2 class=article-title>III: 基于私有数据使用LangChain构建聊天机器人</h2></div></a></article><article><a href=/p/i-%E5%9F%BA%E4%BA%8Elangchain%E7%9A%84%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%8A/><div class=article-details><h2 class=article-title>I: 基于LangChain的大语言模型应用开发(上)</h2></div></a></article><article><a href=/p/i-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF%E9%89%B4%E8%B5%8F/><div class=article-details><h2 class=article-title>I: 向量数据库技术鉴赏</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 importzhh的小破站</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>